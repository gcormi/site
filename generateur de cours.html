<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant Pédagogique Avancé</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e9eef2; /* Light cool gray background */
            color: #2d3748; /* Darker gray for body text */
        }
        .label-text { font-weight: 500; color: #4a5568; /* Slightly lighter label text */ }
        textarea::-webkit-scrollbar { width: 10px; }
        textarea::-webkit-scrollbar-track { background: #edf2f7; border-radius: 10px; }
        textarea::-webkit-scrollbar-thumb { background: #a0aec0; border-radius: 10px; }
        textarea::-webkit-scrollbar-thumb:hover { background: #718096; }

        .radio-label {
            display: flex; align-items: center; padding: 0.85rem 1.25rem; border: 1px solid #cbd5e0;
            border-radius: 0.5rem; cursor: pointer; transition: all 0.25s ease-in-out;
            background-color: #ffffff; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.03);
        }
        .radio-label:hover {
            background-color: #f7fafc; border-color: #4299e1; /* Brighter blue on hover */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.07), 0 1px 2px 0 rgba(0, 0, 0, 0.04);
        }
        .radio-label input[type="radio"] { margin-right: 0.75rem; accent-color: #3182ce; transform: scale(1.25); }
        .radio-label.selected {
            background-color: #ebf8ff; border-color: #3182ce; font-weight: 600;
            color: #2c5282; box-shadow: 0 0 0 2px rgba(49, 130, 206, 0.4);
        }

        .main-container {
            background-color: #ffffff;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); /* Softer, more spread shadow */
            border-radius: 0.75rem;
        }
        .input-field, .select-field, .color-input-field {
            border: 1px solid #cbd5e0; /* Lighter border */
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background-color: #f8fafc; /* Very light input background */
        }
        .input-field:focus, .select-field:focus, .color-input-field:focus {
            border-color: #3182ce; /* Tailwind blue-500 */
            box-shadow: 0 0 0 3px rgba(49,130,206,0.3);
            background-color: #ffffff;
        }
        .color-input-field { /* Specific style for color inputs for better consistency */
            padding: 0.3rem 0.5rem; /* Adjust padding for color input */
            height: 2.8rem; /* Match height of other inputs */
            border-radius: 0.375rem; /* Tailwind default rounded-md */
        }

        .btn {
            padding: 0.75rem 1.5rem; /* Slightly more padding */
            border-radius: 0.5rem; font-weight: 600; text-align: center;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px 0 rgba(0,0,0,0.08);
        }
        .btn:focus { outline: none; box-shadow: 0 0 0 3px rgba(49,130,206,0.4), 0 2px 4px 0 rgba(0,0,0,0.08); }

        .btn-primary { background-color: #3182ce; color: white; } /* Tailwind blue-600 */
        .btn-primary:hover { background-color: #2b6cb0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); transform: translateY(-1px); }
        .btn-secondary { background-color: #38a169; color: white; } /* Tailwind green-600 */
        .btn-secondary:hover { background-color: #2f855a; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); transform: translateY(-1px); }
        .btn-info { background-color: #319795; color: white; } /* Tailwind teal-600 */
        .btn-info:hover { background-color: #2c7a7b; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); transform: translateY(-1px); }
        .btn-accent { background-color: #805ad5; color: white; } /* Tailwind purple-600 */
        .btn-accent:hover { background-color: #6b46c1; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); transform: translateY(-1px); }
        .btn-copy-alt { background-color: #718096; color: white; } /* Tailwind gray-600 */
        .btn-copy-alt:hover { background-color: #4a5568; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); transform: translateY(-1px); }
        .btn-warning { background-color: #dd6b20; color: white; } /* Tailwind orange-600 */
        .btn-warning:hover { background-color: #c05621; }
        .btn-convert { background-color: #5a67d8; color:white; } /* Tailwind indigo-600 */
        .btn-convert:hover { background-color: #4c51bf; }
        .btn-docx { background-color: #2b6cb0; color:white; } /* Tailwind blue-700 */
        .btn-docx:hover { background-color: #2c5282; }
        .btn-docx-no-corr { background-color: #d69e2e; color: white;} /* Tailwind yellow-600 */
        .btn-docx-no-corr:hover { background-color: #b7791f;}

        .questions-render-container {
            padding: 30px; background-color: white; border: 1px solid #e2e8f0;
            font-family: 'Inter', sans-serif; color: #333; width: 800px; box-sizing: border-box;
            border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .questions-render-container h3 {
            font-size: 1.5em; font-weight: 700; margin-bottom: 25px; color: #2c5282; /* Darker blue */
            text-align: center; border-bottom: 2px solid #bee3f8; padding-bottom: 10px;
        }
        .questions-render-container ul { list-style-type: none; padding-left: 0; }
        .questions-render-container > ul > li, .questions-render-container .question-item { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px dashed #e2e8f0; }
        .questions-render-container > ul > li:last-child, .questions-render-container .question-item:last-child { border-bottom: none; }

        .questions-render-container .question-text { font-weight: 600; margin-bottom: 10px; font-size: 1.1em; color: #2d3748; }
        .questions-render-container .answer-text { font-style: italic; color: #2f855a; padding-left: 25px; font-weight: 600; background: #f0fff4; padding: 5px 10px; border-left: 3px solid #38a169; border-radius: 4px;}

        .questions-render-container .mcq-question-block .mcq-question-text {
            font-weight: 600; margin-bottom: 10px; font-size: 1.1em; color: #2d3748;
        }
        .questions-render-container .mcq-question-block .mcq-options-list {
            list-style-type: none; padding-left: 25px; margin-top: 10px; counter-reset: mcq-option-render;
        }
        .questions-render-container .mcq-question-block .mcq-options-list li {
            padding-bottom: 8px; margin-bottom: 0; border-bottom: none; font-size: 1em;
        }
        .questions-render-container .mcq-question-block .mcq-options-list li::before {
            content: counter(mcq-option-render, upper-alpha) ". ";
            counter-increment: mcq-option-render;
            font-weight: 500; margin-right: 8px; color: #4a5568;
        }
        .questions-render-container .mcq-question-block .mcq-correction-text {
            margin-top: 12px; font-weight: bold; color: #38a169; padding-left:0px; font-size: 1.05em;
            background: #f0fff4; padding: 8px 12px; border-left: 3px solid #38a169; border-radius: 4px;
        }
         .questions-render-container .mcq-parsing-error-note {
            color: #c53030; font-style:italic; font-size:0.9em; margin-top: 8px; display: block;
            background: #fff5f5; padding: 8px; border-left: 3px solid #c53030; border-radius: 4px;
        }

        .image-output-wrapper img.hidden, .image-output-wrapper a.hidden { display: none !important; }
        .image-output-wrapper img:not(.hidden) ~ p.placeholder-text, .image-output-wrapper a:not(.hidden) ~ p.placeholder-text { display: none !important; }

        .section-divider {
            border-top: 2px solid #63b3ed; /* Brighter blue for divider */
            margin-top: 3rem; padding-top: 3rem;
        }
        .subsection {
            background-color: #f7fafc; /* Lighter subsection background */
            padding: 2rem; border-radius: 0.5rem; margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03); /* Subtler shadow */
            border: 1px solid #e2e8f0;
        }
        .subsection h3 {
            font-size: 1.35rem; font-weight:700; color: #2c5282; /* Darker blue for subsection titles */
            margin-bottom:1.25rem;
        }
        .subsection h4 {
            font-size: 1.15rem; font-weight:600; color: #2b6cb0; /* Medium blue for sub-subsection titles */
            margin-bottom:0.85rem;
        }

        .instruction-text {
            font-size: 0.9rem; color: #4a5568; background-color: #ebf8ff; /* Light blue background */
            padding: 1rem; border-radius: 0.375rem; border: 1px solid #bee3f8; /* Light blue border */
            margin-bottom: 1.25rem;
        }
        .instruction-text strong { color: #2c5282; }
        .instruction-text code { background-color: #bee3f8; padding: 0.1rem 0.3rem; border-radius: 0.25rem; font-family: monospace; color: #2c5282; }
        .select-field { padding: 0.75rem; }
        .button-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; margin-top: 0.75rem; margin-bottom: 0.25rem;}
        .conversion-message { font-size: 0.8rem; font-weight: 500; margin-top: 0.75rem; text-align: center; min-height: 1.2rem; padding: 0.25rem;}
        .conversion-success { color: #2f855a; background-color: #f0fff4; border: 1px solid #9ae6b4; border-radius: 0.25rem; }
        .conversion-error { color: #c53030; background-color: #fff5f5; border: 1px solid #feb2b2; border-radius: 0.25rem; }

        .app-introduction {
            background: linear-gradient(135deg, #e0f2fe 0%, #ccebfd 100%); /* Light blue gradient */
            padding: 2rem;
            border-radius: 0.75rem; /* Larger radius */
            margin-bottom: 3rem; /* Space before the first section */
            border: 1px solid #90cdf4; /* Medium light blue border */
            box-shadow: 0 8px 16px rgba(100, 150, 200, 0.1);
        }
        .app-introduction h2 {
            font-size: 1.75rem; /* Larger for "Sommaire" */
            font-weight: 700;
            color: #2a4365; /* Darker, desaturated blue */
            margin-bottom: 1.25rem;
        }
        .app-introduction h3 {
            font-size: 1.35rem; /* For "Texte Explicatif" title */
            font-weight: 600;
            color: #2c5282; /* Medium blue */
            margin-top: 1.75rem;
            margin-bottom: 0.85rem;
        }
        .app-introduction ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            padding-left: 0.5rem;
            color: #4a5568; /* Tailwind gray-700 */
        }
        .app-introduction ul ul { list-style-type: circle; margin-top: 0.35rem; }
        .app-introduction li { margin-bottom: 0.6rem; line-height: 1.7; }
        .app-introduction p { margin-bottom: 0.85rem; line-height: 1.7; color: #4a5568; }
        .app-introduction strong { color: #2c5282; }

        .page-title {
            font-size: 2.5rem; /* Tailwind text-4xl */
            font-weight: 800; /* font-extrabold */
            background: -webkit-linear-gradient(45deg, #3182ce, #6b46c1); /* blue-600 to purple-600 */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem; /* Adjusted from mt-3 for p to mb for h1 */
        }
        .page-subtitle {
            color: #4a5568; /* gray-600 */
            margin-top: 0.25rem; /* Reduced from mt-3 */
            font-size: 1.125rem; /* text-lg */
        }
        /* Styling for the new section 5 inputs */
        .design-option-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .design-option-item label {
            display: block;
            margin-bottom: 0.3rem;
            font-size: 0.875rem; /* text-sm */
        }

    </style>
</head>
<body class="text-slate-800 p-4 md:p-8 min-h-screen flex flex-col items-center">
    <div class="w-full max-w-5xl main-container p-6 md:p-10 my-8"> <!-- Increased max-w-4xl to max-w-5xl -->
        <header class="mb-8 text-center"> <!-- Reduced mb from 10 to 8 -->
            <h1 class="page-title">Assistant Pédagogique Avancé</h1>
            <p class="page-subtitle">Générez prompts, supports de cours & exercices pour la technologie au collège.</p>
        </header>

        <section class="app-introduction">
            <h2>Sommaire de l'Application</h2>
            <ul>
                <li><strong>1. Générateur de Prompts pour Module de Cours</strong>
                    <ul>
                        <li>1.1 Choix Niveau & Module</li>
                        <li>1.2 Personnalisation (Thèmes élèves, Format sortie)</li>
                        <li>1.3 Génération du Prompt Module</li>
                        <li>1.4 Outils Annexes (Cahier de texte, Résumé élèves)</li>
                    </ul>
                </li>
                <li><strong>2. Outils pour Exercices : Génération de Prompts</strong>
                    <ul>
                        <li>(Prérequis : Contenu du cours)</li>
                        <li>2.1 Prompt pour Questions à Réponse Courte</li>
                        <li>2.2 Prompt pour QCM (sortie Tableau Markdown)</li>
                        <li>2.3 Prompt pour Résumé de Cours</li>
                        <li>2.4 Prompt pour Exercice de Regroupement</li>
                    </ul>
                </li>
                <li><strong>3. Convertir Texte d'Exercices en Supports</strong>
                    <ul>
                        <li>3.1 Questions Courtes : Texte vers Image / DOCX</li>
                        <li>3.2 QCM : Tableau vers Format Texte, puis Texte vers Image / DOCX</li>
                    </ul>
                </li>
                <li><strong>4. Générer Image Combinée des Exercices</strong></li>
                <li><strong>5. Générer Prompt pour Améliorer le Design d'un Cours HTML Existant</strong> <!-- NOUVEAU LIBELLÉ -->
                    <ul>
                        <li>5.1 Import du Code HTML du cours existant</li>
                        <li>5.2 Choix des options de design (couleurs, style, images, etc.)</li>
                        <li>5.3 Génération du Prompt de Modification pour IA</li>
                    </ul>
                </li>
            </ul>

            <h3>Présentation des Fonctionnalités</h3>
            <p>Cet outil web est conçu pour assister les enseignants de technologie au collège dans la création de supports pédagogiques variés et interactifs. Il se divise en plusieurs sections principales :</p>

            <p><strong>1. Génération de Prompts pour Modules de Cours (Section 1)</strong><br>
            Permet de créer des instructions détaillées (prompts) à fournir à une Intelligence Artificielle (IA) pour la génération de modules de cours complets. L'enseignant sélectionne le niveau, le module désiré, et peut personnaliser les thèmes. Le format de sortie (DOCX ou HTML) influence les instructions. Des outils annexes génèrent une phrase pour le cahier de texte et un résumé pour les élèves.</p>

            <p><strong>2. Génération de Prompts pour Exercices (Section 2)</strong><br>
            À partir d'un contenu de cours, génère des prompts pour créer divers exercices : Questions à Réponse Courte, QCM (demandant un format tableau à l'IA), Résumé, et Exercice de Regroupement.</p>

            <p><strong>3. Conversion de Texte d'Exercices en Supports Visuels (Section 3)</strong><br>
            Transforme le texte d'exercices en images ou DOCX.
            Pour les <strong>Questions Courtes</strong> (format <code>Question :: Réponse</code>), génère image/DOCX, avec ou sans correction.
            Pour les <strong>QCM</strong>, si l'IA fournit un tableau Markdown, un bouton le convertit en format texte standardisé. Ensuite, ce format peut être utilisé pour générer image/DOCX, avec ou sans correction.</p>

            <p><strong>4. Génération d'Image Combinée des Exercices (Section 4)</strong><br>
            Crée une image unique regroupant questions courtes et QCM, avec option d'afficher/masquer les corrections.</p>

            <p><strong>5. Génération de Prompt pour Améliorer le Design d'un Cours HTML Existant (Section 5)</strong><br> <!-- NOUVEAU LIBELLÉ -->
            Permet de créer un prompt détaillé pour une IA, afin qu'elle modifie le design d'un <strong>code HTML de cours déjà existant</strong>. L'utilisateur colle son code HTML, spécifie ses préférences de design (couleurs, style, images, etc.), et l'outil génère un prompt complet demandant à l'IA d'appliquer ces modifications au code HTML fourni.</p>

            <p><strong>Objectif global :</strong> Faciliter et accélérer la création de matériel pédagogique en tirant parti des IA génératives, tout en offrant des outils de formatage, d'export et de personnalisation avancée.</p>
        </section>


        <main>
            <div class="mb-10 p-6 border border-sky-200 rounded-lg bg-sky-50 shadow-lg"> <!-- Slightly increased shadow -->
                <h2 class="text-2xl font-semibold text-sky-700 mb-6 text-center">1. Générateur de Prompts pour Module de Cours</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 mb-8">
                    <div>
                        <label for="gradeSelect" class="block text-sm label-text text-slate-700 mb-1.5">Niveau (Classe) :</label>
                        <select id="gradeSelect" class="w-full p-3 rounded-md shadow-sm input-field select-field">
                            <option value="">-- Choisir un niveau --</option>
                            <option value="5e">5ème</option>
                            <option value="4e">4ème</option>
                            <option value="3e">3ème</option>
                        </select>
                    </div>
                    <div>
                        <label for="moduleSelect" class="block text-sm label-text text-slate-700 mb-1.5">Module :</label>
                        <select id="moduleSelect" class="w-full p-3 rounded-md shadow-sm input-field select-field" disabled>
                            <option value="">-- Choisir un module --</option>
                        </select>
                    </div>
                </div>
                <div class="mb-8">
                    <label for="studentThemesInput" class="block text-sm label-text text-slate-700 mb-1.5">Thèmes chers aux élèves (ex: jeux vidéo, réseaux sociaux) :</label>
                    <input type="text" id="studentThemesInput" value="les jeux vidéo, les smartphones, les réseaux sociaux, les robots" class="w-full p-3 rounded-md shadow-sm input-field">
                </div>
                <div class="mb-10">
                    <label class="block text-sm label-text text-slate-700 mb-2.5">Format de sortie souhaité pour le module :</label>
                    <div class="flex flex-col sm:flex-row gap-4" id="outputFormatGroup">
                        <label class="radio-label flex-1" for="formatDocx">
                            <input type="radio" id="formatDocx" name="outputFormat" value="docx" checked> Document DOCX
                        </label>
                        <label class="radio-label flex-1" for="formatHtml">
                            <input type="radio" id="formatHtml" name="outputFormat" value="html"> Page Web Interactive
                        </label>
                    </div>
                </div>
                <div class="mb-8 text-center">
                    <button id="generateButton" class="btn btn-primary text-lg">Générer Prompt pour Module</button>
                </div>
                <div>
                    <label for="outputPrompt" class="block text-sm label-text text-slate-700 mb-1.5">Prompt de Module généré :</label>
                    <textarea id="outputPrompt" rows="15" class="w-full p-4 rounded-md shadow-sm bg-slate-100 text-sm input-field" readonly placeholder="Le prompt détaillé pour la génération du module apparaîtra ici..."></textarea>
                    <button id="copyButton" class="mt-3 btn btn-secondary">Copier Prompt Module</button>
                    <p id="copyMessage" class="text-sm text-green-700 font-medium mt-1 h-5"></p>
                </div>
                <div class="mt-8 pt-6 border-t border-slate-300">
                  <h3 class="text-xl font-semibold text-slate-700 mb-4 text-center">Outils Pédagogiques Annexes (Module)</h3>
                  <div class="flex flex-col sm:flex-row gap-4 mb-4 justify-center">
                    <button id="logbookButton" class="btn btn-info flex-1 max-w-xs">Phrase Cahier de Texte</button>
                    <button id="summaryButton" class="btn btn-accent flex-1 max-w-xs">Résumé Connaissances</button>
                  </div>
                  <div>
                    <label for="pedagogicalOutput" id="pedagogicalOutputLabel" class="block text-sm label-text text-slate-700 mb-1.5">Sortie des outils annexes :</label>
                    <textarea id="pedagogicalOutput" rows="8" class="w-full p-4 rounded-md shadow-sm bg-slate-100 text-sm input-field" readonly placeholder="Le contenu généré par les outils annexes apparaîtra ici..."></textarea>
                    <button id="copyPedagogicalOutputButton" class="mt-3 btn btn-copy-alt">Copier Texte Annexe</button>
                    <p id="copyPedagogicalOutputMessage" class="text-sm text-green-700 font-medium mt-1 h-5"></p>
                  </div>
                </div>
            </div>

             <div class="section-divider">
                <h2 class="text-2xl font-semibold text-sky-700 mb-6 text-center">2. Outils pour Exercices et Supports Complémentaires</h2>
                <div class="mb-6 p-4 border border-blue-200 rounded-lg bg-blue-50">
                    <label for="courseContentInputForExercises" class="block text-sm label-text text-blue-700 mb-1.5 font-semibold">Collez ici le contenu du cours (texte ou HTML) pour toutes les sous-sections ci-dessous (2.1 à 2.4) :</label>
                    <textarea id="courseContentInputForExercises" rows="12" class="w-full p-4 rounded-md shadow-sm bg-white text-sm input-field" placeholder="Contenu du cours à utiliser comme base pour les exercices, résumés, etc."></textarea>
                </div>

                <div class="subsection">
                    <h3 class="text-center md:text-left">2.1 Générer Prompt pour Questions à Réponse Courte</h3>
                     <div class="mb-4">
                        <label for="numShortQuestions" class="block text-xs label-text text-slate-600 mb-1">Nombre de questions (5-25) :</label>
                        <input type="number" id="numShortQuestions" value="10" min="5" max="25" class="w-full p-2.5 rounded-md shadow-sm input-field text-sm">
                    </div>
                    <button id="generatePromptShortQuestionsBtn" class="btn btn-primary w-full mb-3">Générer Prompt</button>
                    <textarea id="promptShortQuestionsOutput" rows="8" class="w-full p-3 rounded-md shadow-sm bg-slate-100 text-xs input-field" readonly placeholder="Le prompt pour l'IA (questions courtes) apparaîtra ici..."></textarea>
                    <button id="copyPromptShortQuestionsBtn" class="mt-2 btn btn-secondary w-full">Copier Prompt</button>

                    <p id="copyPromptShortMessage" class="text-xs text-green-700 font-medium mt-1 h-4 text-center"></p>
                </div>

                <div class="subsection">
                    <h3 class="text-center md:text-left">2.2 Générer Prompt pour QCM</h3>
                    <div class="mb-4">
                        <label for="numMCQ" class="block text-xs label-text text-slate-600 mb-1">Nombre de QCM (5-20) :</label>
                        <input type="number" id="numMCQ" value="7" min="5" max="20" class="w-full p-2.5 rounded-md shadow-sm input-field text-sm">
                    </div>
                    <div class="mb-4">
                        <label for="numChoicesMCQ" class="block text-xs label-text text-slate-600 mb-1">Nombre de propositions par QCM :</label>
                        <select id="numChoicesMCQ" class="w-full p-2.5 rounded-md shadow-sm input-field select-field text-sm">
                            <option value="3">3 propositions</option>
                            <option value="4" selected>4 propositions</option>
                        </select>
                    </div>
                    <button id="generatePromptMCQBtn" class="btn btn-primary w-full mb-3">Générer Prompt</button>
                    <textarea id="promptMCQOutput" rows="12" class="w-full p-3 rounded-md shadow-sm bg-slate-100 text-xs input-field" readonly placeholder="Le prompt pour l'IA (QCM en format Tableau Markdown) apparaîtra ici..."></textarea>
                    <button id="copyPromptMCQBtn" class="mt-2 btn btn-secondary w-full">Copier Prompt</button>
                    <p id="copyPromptMCQMessage" class="text-xs text-green-700 font-medium mt-1 h-4 text-center"></p>
                </div>

                <div class="subsection">
                    <h3 class="text-center md:text-left">2.3 Générer Prompt pour Résumé de Cours</h3>
                     <p class="text-xs text-slate-500 mb-3">Génère un prompt pour demander à une IA de résumer le cours (collé ci-dessus) en environ 180 mots.</p>
                    <button id="generatePromptSummaryBtn" class="btn btn-primary w-full mb-3">Générer Prompt</button>
                    <textarea id="promptSummaryOutput" rows="8" class="w-full p-3 rounded-md shadow-sm bg-slate-100 text-xs input-field" readonly placeholder="Le prompt pour l'IA (résumé) apparaîtra ici..."></textarea>
                    <button id="copyPromptSummaryBtn" class="mt-2 btn btn-secondary w-full">Copier Prompt</button>
                    <p id="copyPromptSummaryMessage" class="text-xs text-green-700 font-medium mt-1 h-4 text-center"></p>
                </div>

                 <div class="subsection">
                    <h3 class="text-center md:text-left">2.4 Générer Prompt pour Exercice de Regroupement</h3>
                    <p class="text-xs text-slate-500 mb-3">Génère un prompt pour demander à une IA de créer un exercice de regroupement à partir du cours (collé ci-dessus).</p>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="numRegroupementZones" class="block text-xs label-text text-slate-600 mb-1">Nombre de zones (2-4) :</label>
                            <input type="number" id="numRegroupementZones" value="3" min="2" max="4" class="w-full p-2.5 rounded-md shadow-sm input-field text-sm">
                        </div>
                        <div>
                            <label for="numRegroupementItems" class="block text-xs label-text text-slate-600 mb-1">Éléments par zone (3-8) :</label>
                            <input type="number" id="numRegroupementItems" value="5" min="3" max="8" class="w-full p-2.5 rounded-md shadow-sm input-field text-sm">
                        </div>
                    </div>
                    <button id="generatePromptRegroupementBtn" class="btn btn-primary w-full mb-3">Générer Prompt</button>
                    <textarea id="promptRegroupementOutput" rows="10" class="w-full p-3 rounded-md shadow-sm bg-slate-100 text-xs input-field" readonly placeholder="Le prompt pour l'IA (regroupement) apparaîtra ici..."></textarea>
                    <button id="copyPromptRegroupementBtn" class="mt-2 btn btn-secondary w-full">Copier Prompt</button>
                    <p id="copyPromptRegroupementMessage" class="text-xs text-green-700 font-medium mt-1 h-4 text-center"></p>
                </div>
            </div>

            <div class="section-divider">
                <h2 class="text-2xl font-semibold text-sky-700 mb-6 text-center">3. Convertir Texte d'Exercices (généré par IA) en Image ou DOCX</h2>
                <div class="grid md:grid-cols-2 gap-x-6 gap-y-8">
                    <div class="subsection">
                        <h3 class="text-center md:text-left">Questions Courtes : Sorties</h3>
                        <div class="instruction-text">
                             <p>Collez les questions courtes et leurs réponses générées par l'IA.<br>
                            <strong>Format attendu :</strong> Séparation <code>::</code> entre question et réponse. La question doit être une phrase complète.</p>
                        </div>
                        <textarea id="textShortQuestionsInput" rows="10" class="w-full p-3 rounded-md shadow-sm bg-slate-50 text-sm input-field" placeholder="Ex: Quelle notion désigne une suite d'instructions ? :: Algorithme"></textarea>

                        <h4 class="text-sm font-semibold mt-4 mb-1 text-slate-600">Exporter en Image :</h4>
                        <div class="button-grid">
                            <button id="convertShortToImageWithCorrectionBtn" class="btn btn-primary">Image AVEC Cor.</button>
                            <button id="convertShortToImageWithoutCorrectionBtn" class="btn btn-warning">Image SANS Cor.</button>
                        </div>

                        <h4 class="text-sm font-semibold mt-3 mb-1 text-slate-600">Exporter en DOCX :</h4>
                        <div class="button-grid">
                            <button id="exportShortToDocxWithCorrectionBtn" class="btn btn-docx">DOCX AVEC Cor.</button>
                            <button id="exportShortToDocxWithoutCorrectionBtn" class="btn btn-docx-no-corr">DOCX SANS Cor.</button>
                        </div>

                        <div id="shortQuestionsOutputWrapper" class="image-output-wrapper mt-3">
                            <h4 class="text-md font-medium text-slate-600 mb-1">Aperçu Image (si générée) :</h4>
                            <div class="p-3 border border-dashed border-slate-300 rounded-md bg-slate-100 min-h-[150px] flex justify-center items-center overflow-auto">
                                <img id="shortQuestionsImage" src="#" alt="Image des questions à réponses courtes" class="max-w-full h-auto hidden">
                                <p id="shortQuestionsPlaceholder" class="text-slate-400 placeholder-text">L'aperçu de l'image des questions courtes apparaîtra ici.</p>
                            </div>
                            <a id="downloadShortLink" href="#" class="btn btn-info mt-2 inline-block hidden" download="questions_courtes.png">Télécharger Image</a>
                        </div>
                    </div>

                    <div class="subsection">
                        <h3 class="text-center md:text-left">QCM : Sorties</h3>
                        <div class="instruction-text">
                             <p>Collez les QCM générés par l'IA. <br>
                                <strong>Étape 1 (si tableau):</strong> Si l'IA a fourni un Tableau Markdown, collez-le ci-dessous et cliquez sur "Convertir Tableau en Format QCM".<br>
                                <strong>Étape 2 (format QCM):</strong> Si vous avez un format QCM multilignes (Question, Options, Bonne réponse:, ---) ou après l'étape 1, utilisez les boutons "Image..." ou "DOCX...".</p>
                        </div>
                        <textarea id="textMCQInput" rows="10" class="w-full p-3 rounded-md shadow-sm bg-slate-50 text-sm input-field" placeholder="Collez le Tableau Markdown ou le format QCM multilignes ici..."></textarea>
                        <button id="convertMCQTableBtn" class="mt-2 btn btn-convert w-full">Convertir Tableau en Format QCM</button>
                        <p id="mcqConversionMessage" class="conversion-message"></p>

                        <h4 class="text-sm font-semibold mt-4 mb-1 text-slate-600">Exporter en Image :</h4>
                        <div class="button-grid">
                            <button id="convertMCQToImageWithCorrectionBtn" class="btn btn-primary">Image AVEC Cor.</button>
                            <button id="convertMCQToImageWithoutCorrectionBtn" class="btn btn-warning">Image SANS Cor.</button>
                        </div>

                        <h4 class="text-sm font-semibold mt-3 mb-1 text-slate-600">Exporter en DOCX :</h4>
                        <div class="button-grid">
                           <button id="exportMCQToDocxWithCorrectionBtn" class="btn btn-docx">DOCX AVEC Cor.</button>
                           <button id="exportMCQToDocxWithoutCorrectionBtn" class="btn btn-docx-no-corr">DOCX SANS Cor.</button>
                        </div>

                        <div id="mcqOutputWrapper" class="image-output-wrapper mt-3">
                            <h4 class="text-md font-medium text-slate-600 mb-1">Aperçu Image (si générée) :</h4>
                            <div class="p-3 border border-dashed border-slate-300 rounded-md bg-slate-100 min-h-[150px] flex justify-center items-center overflow-auto">
                                <img id="mcqImage" src="#" alt="Image des QCM" class="max-w-full h-auto hidden">
                                <p id="mcqPlaceholder" class="text-slate-400 placeholder-text">L'aperçu de l'image des QCM apparaîtra ici.</p>
                            </div>
                            <a id="downloadMcqLink" href="#" class="btn btn-info mt-2 inline-block hidden" download="qcm.png">Télécharger Image</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-divider">
                <h2 class="text-2xl font-semibold text-sky-700 mb-6 text-center">4. Générer Image Combinée des Exercices</h2>
                <div class="subsection">
                    <p class="text-sm text-slate-600 mb-4 text-center">Utilisez cette section pour générer une image unique contenant à la fois les questions courtes (de la section 3.1) et les QCM (de la section 3.2). Assurez-vous que le contenu QCM dans la zone de texte de la section 3.2 est au format multilignes attendu (convertissez le tableau si besoin).</p>
                    <div class="button-grid">
                        <button id="convertCombinedToImageWithCorrectionBtn" class="btn btn-primary text-lg">Image Combinée AVEC Correction</button>
                        <button id="convertCombinedToImageWithoutCorrectionBtn" class="btn btn-warning text-lg">Image Combinée SANS Correction</button>
                    </div>
                    <div id="combinedOutputWrapper" class="image-output-wrapper mt-6">
                        <h4 class="text-md font-medium text-slate-600 mb-1">Résultat Image Combinée :</h4>
                        <div class="p-3 border border-dashed border-slate-300 rounded-md bg-slate-100 min-h-[200px] flex justify-center items-center overflow-auto">
                            <img id="combinedImage" src="#" alt="Image combinée des exercices" class="max-w-full h-auto hidden">
                            <p id="combinedPlaceholder" class="text-slate-400 placeholder-text">L'image combinée des exercices apparaîtra ici.</p>
                        </div>
                        <a id="downloadCombinedLink" href="#" class="btn btn-info mt-2 inline-block hidden" download="exercices_combines.png">Télécharger Image Combinée</a>
                    </div>
                </div>
            </div>

            <!-- SECTION 5 : MODIFIÉE SELON LA DERNIÈRE DEMANDE -->
            <div class="section-divider">
                <h2 class="text-2xl font-semibold text-sky-700 mb-6 text-center">5. Générer Prompt pour Améliorer le Design d'un Cours HTML Existant</h2>
                <div class="subsection">
                    <div class="instruction-text">
                        <p>Cette section vous permet de générer un prompt pour une IA afin qu'elle <strong>modifie le design d'un code HTML de cours existant</strong>. Collez le code HTML complet de votre cours ci-dessous, choisissez vos options de design, puis générez un prompt détaillé que vous fournirez à votre IA.</p>
                    </div>

                    <div class="mb-6">
                        <label for="existingHtmlCourseCodeInput" class="block text-sm label-text text-slate-700 mb-1.5">Code HTML du Cours Existant (généré par une IA ou écrit manuellement) :</label>
                        <textarea id="existingHtmlCourseCodeInput" rows="10" class="w-full p-3 rounded-md shadow-sm input-field" placeholder="Collez ici le code HTML complet de votre page de cours..."></textarea>
                    </div>

                    <h4 class="text-lg font-semibold text-slate-700 mb-4">Options de Design à Appliquer au Code HTML ci-dessus :</h4>

                    <div class="design-option-grid">
                        <div class="design-option-item">
                            <label for="designColorPrimary" class="label-text">Couleur Primaire :</label>
                            <input type="color" id="designColorPrimary" value="#3182CE" class="w-full color-input-field">
                        </div>
                        <div class="design-option-item">
                            <label for="designColorSecondary" class="label-text">Couleur Secondaire :</label>
                            <input type="color" id="designColorSecondary" value="#63B3ED" class="w-full color-input-field">
                        </div>
                        <div class="design-option-item">
                            <label for="designColorAccent" class="label-text">Couleur d'Accentuation :</label>
                            <input type="color" id="designColorAccent" value="#805AD5" class="w-full color-input-field">
                        </div>
                    </div>

                    <div class="design-option-grid">
                        <div class="design-option-item">
                            <label for="designGeneralStyle" class="label-text">Style Général :</label>
                            <select id="designGeneralStyle" class="w-full p-2.5 rounded-md shadow-sm input-field select-field text-sm">
                                <option value="Moderne et épuré">Moderne et épuré</option>
                                <option value="Ludique et coloré">Ludique et coloré</option>
                                <option value="Professionnel et sobre">Professionnel et sobre</option>
                                <option value="Minimaliste High-Tech">Minimaliste High-Tech</option>
                                <option value="Académique et structuré">Académique et structuré</option>
                            </select>
                        </div>
                         <div class="design-option-item">
                            <label for="designIconStyle" class="label-text">Style des Pictogrammes :</label>
                            <select id="designIconStyle" class="w-full p-2.5 rounded-md shadow-sm input-field select-field text-sm">
                                <option value="Emojis pertinents intégrés au texte">Emojis pertinents</option>
                                <option value="Icônes SVG monochromes (style Material Design ou similaire)">Icônes SVG monochromes</option>
                                <option value="Icônes SVG colorées et illustratives">Icônes SVG colorées</option>
                                <option value="Pas de préférence spécifique, laisser l'IA choisir">Pas de préférence</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label for="designImageInstructions" class="block text-sm label-text text-slate-700 mb-1.5">Insertion d'Images (une par ligne : URL libre_de_droit --- Description précise de l'emplacement dans le HTML) :</label>
                        <textarea id="designImageInstructions" rows="4" class="w-full p-3 rounded-md shadow-sm input-field" placeholder="Ex: https://images.pexels.com/photo/robot.jpg --- Juste après le premier paragraphe (&lt;p&gt;) contenu dans la balise &lt;main&gt;. Ou avant le &lt;h2&gt; ayant pour texte 'Chapitre 1'."></textarea>
                         <p class="text-xs text-slate-500 mt-1">Assurez-vous que les URLs pointent vers des images libres de droits. Soyez précis sur l'emplacement.</p>
                    </div>

                    <div class="mb-8">
                        <label for="designOtherImprovements" class="block text-sm label-text text-slate-700 mb-1.5">Autres Améliorations de Design (instructions spécifiques pour l'IA) :</label>
                        <textarea id="designOtherImprovements" rows="4" class="w-full p-3 rounded-md shadow-sm input-field" placeholder="Ex: Rendre les tableaux plus lisibles avec des bordures alternées, ajouter un effet de parallaxe sur une image de fond si pertinent, changer la police de tous les paragraphes pour 'Lato'..."></textarea>
                    </div>

                    <div class="mb-8 text-center">
                        <button id="generateDesignModificationPromptBtn" class="btn btn-accent text-lg">Générer Prompt de Modification de Design</button>
                    </div>

                    <div>
                        <label for="designModificationPromptOutput" class="block text-sm label-text text-slate-700 mb-1.5">Prompt de Modification de Design (prêt à copier pour l'IA) :</label>
                        <textarea id="designModificationPromptOutput" rows="15" class="w-full p-4 rounded-md shadow-sm bg-slate-100 text-sm input-field" readonly placeholder="Le prompt demandant à une IA de modifier votre code HTML avec vos instructions de design apparaîtra ici..."></textarea>
                        <button id="copyDesignModificationPromptBtn" class="mt-3 btn btn-secondary">Copier Prompt de Modification</button>
                        <p id="copyDesignModificationPromptMessage" class="text-sm text-green-700 font-medium mt-1 h-5"></p>
                    </div>
                </div>
            </div>
            <!-- FIN SECTION 5 MODIFIÉE -->

        </main>

        <footer class="mt-12 pt-8 border-t border-slate-300 text-center text-sm text-slate-500">
            <p>Technologie Collège - Assistant Pédagogique Avancé</p>
            <p>&copy; - Testé avec AI studio Google et Gemini</p>
        </footer>
    </div>

    <script>
        // Data for all modules
        const modulesData = {
            "5e": {
                1: { title: "Introduction aux objets techniques", hook: "Comment les objets techniques répondent-ils à nos besoins quotidiens ?", skills: "Identifier un besoin et énoncer un problème technique", knowledge: "Besoin, contraintes, normalisation" },
                2: { title: "Analyse fonctionnelle", hook: "Pourquoi et comment décomposer un objet en fonctions ?", skills: "S'approprier un cahier des charges", knowledge: "Fonctions techniques, solutions techniques" },
                3: { title: "Matériaux et leurs propriétés", hook: "De quoi sont faits les objets qui nous entourent ?", skills: "Identifier le(s) matériau(x)", knowledge: "Familles de matériaux, propriétés, impacts environnementaux" },
                4: { title: "Évolution des objets techniques", hook: "Comment les objets ont-ils évolué au fil du temps ?", skills: "Comparer et commenter les évolutions des objets", knowledge: "Évolution des objets, impacts sociétaux" },
                5: { title: "Les flux d'énergie", hook: "Comment l'énergie circule-t-elle dans un objet technique ?", skills: "Identifier les flux d'énergie", knowledge: "Sources d'énergie, chaîne d'énergie, conversion" },
                6: { title: "Représentation graphique", hook: "Comment représenter un objet pour le comprendre ?", skills: "Exprimer sa pensée à l'aide d'outils de description adaptés", knowledge: "Croquis, schémas, symboles normalisés" },
                7: { title: "Introduction à la programmation", hook: "Comment donner des ordres à une machine ?", skills: "Appliquer les principes élémentaires de l'algorithmique", knowledge: "Algorithme, programme, séquence d'instructions" },
                8: { title: "Les objets connectés", hook: "Comment les objets peuvent-ils communiquer entre eux ?", skills: "Comprendre le fonctionnement d'un réseau informatique", knowledge: "Objets connectés, réseaux, interfaces" },
                9: { title: "Mesure et instrumentation", hook: "Comment mesurer les performances d'un objet technique ?", skills: "Mesurer des grandeurs de manière directe ou indirecte", knowledge: "Instruments de mesure, grandeurs physiques" },
                10: { title: "Éco-conception", hook: "Comment créer des objets respectueux de l'environnement ?", skills: "Identifier l'impact environnemental des objets", knowledge: "Cycle de vie, recyclage, impact environnemental" },
                11: { title: "Structures mécaniques", hook: "Comment les objets techniques résistent-ils aux forces ?", skills: "Analyser le fonctionnement d'un objet technique", knowledge: "Structures, résistance, équilibre" },
                12: { title: "Conception numérique", hook: "Comment utiliser l'ordinateur pour concevoir des objets ?", skills: "Traduire des choix de solutions sous forme numérique", knowledge: "Outils numériques de conception, modelage 3D" },
                13: { title: "Les chaînes d'information", hook: "Comment l'information circule-t-elle dans un système ?", skills: "Identifier les flux d'information", knowledge: "Chaîne d'information, capteurs, actionneurs" },
                14: { title: "Fabrication et prototypage", hook: "Comment fabriquer concrètement un objet technique ?", skills: "Réaliser, de manière collaborative, le prototype d'un objet", knowledge: "Procédés de fabrication, outils, sécurité" },
                15: { title: "Introduction aux automates", hook: "Comment automatiser des tâches simples ?", skills: "Écrire un programme simple", knowledge: "Automates, capteurs, actionneurs" },
                16: { title: "Initiation au design", hook: "Comment allier esthétique et fonction ?", skills: "Imaginer des solutions en réponse au besoin", knowledge: "Design, ergonomie, esthétique" },
                17: { title: "Habitat et confort", hook: "Comment la technologie améliore-t-elle notre habitat ?", skills: "Associer des solutions techniques à des fonctions", knowledge: "Confort, domotique, énergies" },
                18: { title: "Projet collaboratif", hook: "Comment travailler ensemble pour créer un objet ?", skills: "Participer à l'organisation et au déroulement de projets", knowledge: "Gestion de projet, planification, collaboration" }
            },
            "4e": {
                1: { title: "Cahier des charges avancé", hook: "Comment définir précisément les contraintes d'un projet ?", skills: "S'approprier un cahier des charges complexe", knowledge: "Contraintes dimensionnelles, fonctionnelles, esthétiques" },
                2: { title: "Chaînes d'énergie complexes", hook: "Comment l'énergie est-elle transformée dans un système ?", skills: "Associer des solutions techniques à des fonctions", knowledge: "Chaîne d'énergie, rendement, pertes" },
                3: { title: "Modélisation 3D", hook: "Comment représenter virtuellement un objet en trois dimensions ?", skills: "Traduire à l'aide d'outils numériques des choix de solutions", knowledge: "Modélisation 3D, cotation, assemblage" },
                4: { title: "Programmation et algorithmes", hook: "Comment résoudre des problèmes par la programmation ?", skills: "Écrire, mettre au point et exécuter un programme", knowledge: "Algorithmes, variables, structures de contrôle" },
                5: { title: "Systèmes automatisés", hook: "Comment un système peut-il fonctionner de façon autonome ?", skills: "Analyser le fonctionnement d'un objet technique", knowledge: "Automatisme, boucle, capteurs, actionneurs" },
                6: { title: "Transport et mobilité", hook: "Comment la technologie révolutionne-t-elle nos déplacements ?", skills: "Analyser l'impact environnemental d'un objet", knowledge: "Moyens de transport, énergie, pollution" },
                7: { title: "Choix des matériaux", hook: "Pourquoi choisir un matériau plutôt qu'un autre ?", skills: "Justifier le choix d'un matériau", knowledge: "Propriétés mécaniques, coût, disponibilité" },
                8: { title: "Réseaux informatiques", hook: "Comment les données circulent-elles entre les machines ?", skills: "Comprendre le fonctionnement d'un réseau", knowledge: "Protocoles, routage, sécurité" },
                9: { title: "Design et innovation", hook: "Comment l'innovation transforme-t-elle notre quotidien ?", skills: "Imaginer des solutions innovantes", knowledge: "Veille technologique, innovation, brevets" },
                10: { title: "Systèmes mécaniques", hook: "Comment transmettre et transformer le mouvement ?", skills: "Analyser le fonctionnement et la structure d'un objet", knowledge: "Transmission, transformation, guidage" },
                11: { title: "Développement durable et technologie", hook: "Comment concilier progrès technique et protection de l'environnement ?", skills: "Analyser l'impact environnemental d'un objet", knowledge: "Développement durable, éco-conception, normes" },
                12: { title: "Interface Homme-Machine", hook: "Comment interagir efficacement avec les systèmes techniques ?", skills: "Analyser les échanges d'informations", knowledge: "Ergonomie, interfaces, accessibilité" },
                13: { title: "Capteurs et actionneurs", hook: "Comment un système perçoit-il et agit-il sur son environnement ?", skills: "Analyser le fonctionnement d'un objet technique", knowledge: "Types de capteurs, traitement du signal, actionneurs" },
                14: { title: "Gestion de projet technique", hook: "Comment organiser efficacement un projet technique ?", skills: "Participer à l'organisation de projets", knowledge: "Planification, répartition des tâches, revue de projet" },
                15: { title: "Systèmes embarqués", hook: "Comment intégrer l'intelligence dans les objets ?", skills: "Comprendre le fonctionnement et la structure des objets", knowledge: "Microcontrôleurs, programmation embarquée" },
                16: { title: "Simulation numérique", hook: "Comment prédire le comportement d'un système ?", skills: "Utiliser une modélisation pour comprendre ou prévoir", knowledge: "Logiciels de simulation, paramètres, interprétation" },
                17: { title: "Communication technique", hook: "Comment communiquer efficacement sur un projet technique ?", skills: "Présenter à l'oral des solutions techniques", knowledge: "Documentation technique, schémas normalisés" },
                18: { title: "Projet pluritechnologique", hook: "Comment combiner différentes technologies dans un même projet ?", skills: "Concevoir un projet qui mobilise plusieurs domaines", knowledge: "Intégration de solutions, optimisation, tests" }
            },
            "3e": {
                1: { title: "Innovation et ruptures technologiques", hook: "Comment les grandes innovations transforment-elles la société ?", skills: "Analyser l'impact des objets et systèmes techniques sur la société", knowledge: "Innovations de rupture, impacts sociétaux, prospective" },
                2: { title: "Démarche d'ingénierie", hook: "Comment les ingénieurs conçoivent-ils des solutions complexes ?", skills: "Rechercher des solutions techniques à un problème", knowledge: "Méthode d'ingénierie, analyse systémique, optimisation" },
                3: { title: "Programmation avancée", hook: "Comment programmer des comportements complexes ?", skills: "Développer des programmes pour répondre à des problèmes", knowledge: "Programmation orientée objet, événements, interfaces" },
                4: { title: "Conception collaborative", hook: "Comment travailler en équipe sur des projets techniques ?", skills: "Organiser, structurer et stocker des ressources numériques", knowledge: "Travail collaboratif, partage de données, versions" },
                5: { title: "Robots et systèmes autonomes", hook: "Comment créer des machines qui agissent de façon autonome ?", skills: "Concevoir, créer, programmer un système autonome", knowledge: "Robotique, intelligence artificielle, capteurs avancés" },
                6: { title: "Transition écologique et technologie", hook: "Quel rôle joue la technologie face aux défis environnementaux ?", skills: "Analyser le cycle de vie d'un objet", knowledge: "Empreinte carbone, économie circulaire, sobriété" },
                7: { title: "Systèmes communicants", hook: "Comment les systèmes échangent-ils des informations ?", skills: "Analyser le comportement attendu d'un système réel", knowledge: "Protocoles, IoT, cybersécurité" },
                8: { title: "Optimisation et performances", hook: "Comment améliorer les performances d'un système technique ?", skills: "Définir les critères d'efficacité d'un système", knowledge: "Rendement, fiabilité, maintenabilité" },
                9: { title: "Modélisation et simulation avancées", hook: "Comment anticiper le comportement d'un système complexe ?", skills: "Utiliser une modélisation pour comprendre, formaliser, partager", knowledge: "Simulations multiphysiques, interprétation des résultats" },
                10: { title: "Énergie et développement durable", hook: "Comment concevoir des systèmes énergétiquement efficaces ?", skills: "Analyser le fonctionnement et la structure d'un objet", knowledge: "Efficacité énergétique, énergies renouvelables, stockage" },
                11: { title: "Technologies émergentes", hook: "Quelles sont les technologies qui façonneront notre futur ?", skills: "Imaginer des solutions en réponse au besoin", knowledge: "Technologies émergentes, prospective, impact" },
                12: { title: "Management de projet", hook: "Comment gérer un projet technique de A à Z ?", skills: "Organiser, structurer et planifier un projet", knowledge: "Gestion de projet, planification, évaluation, livrables" },
                13: { title: "Systèmes complexes", hook: "Comment analyser et comprendre un système technique complexe ?", skills: "Identifier les interactions entre les éléments d'un système", knowledge: "Système complexe, interactions, régulation" },
                14: { title: "Sécurité des systèmes", hook: "Comment garantir la sécurité des systèmes techniques ?", skills: "Anticiper des usages et des modifications de systèmes", knowledge: "Sécurité, fiabilité, redondance" },
                15: { title: "Prototypage et fabrication avancés", hook: "Comment passer du concept au produit industriel ?", skills: "Réaliser, de manière collaborative, le prototype d'un objet", knowledge: "Fabrication additive, usinage, contrôle qualité" },
                16: { title: "Orientation professionnelle", hook: "Comment les métiers de la technologie évoluent-ils ?", skills: "Contextualiser les compétences techniques", knowledge: "Métiers, formations, évolution professionnelle" },
                17: { title: "Médiation technologique", hook: "Comment expliquer la technologie à différents publics ?", skills: "Communiquer à l'oral et à l'écrit en utilisant un langage rigoureux", knowledge: "Vulgarisation, communication, médiation" },
                18: { title: "Projet de synthèse", hook: "Comment mobiliser l'ensemble des connaissances acquises ?", skills: "Mobiliser des outils numériques et des compétences techniques", knowledge: "Projet intégrateur, démarche complète" }
            }
        };

        // Selectors
        const gradeSelect = document.getElementById('gradeSelect');
        const moduleSelect = document.getElementById('moduleSelect');
        const studentThemesInput = document.getElementById('studentThemesInput');
        const outputFormatGroup = document.getElementById('outputFormatGroup');
        const generateButton = document.getElementById('generateButton');
        const outputPrompt = document.getElementById('outputPrompt');
        const copyButton = document.getElementById('copyButton');
        const copyMessage = document.getElementById('copyMessage');
        const logbookButton = document.getElementById('logbookButton');
        const summaryButton = document.getElementById('summaryButton');
        const pedagogicalOutput = document.getElementById('pedagogicalOutput');
        const pedagogicalOutputLabel = document.getElementById('pedagogicalOutputLabel');
        const copyPedagogicalOutputButton = document.getElementById('copyPedagogicalOutputButton');
        const copyPedagogicalOutputMessage = document.getElementById('copyPedagogicalOutputMessage');

        const courseContentInputForExercises = document.getElementById('courseContentInputForExercises');
        const numShortQuestions = document.getElementById('numShortQuestions');
        const generatePromptShortQuestionsBtn = document.getElementById('generatePromptShortQuestionsBtn');
        const promptShortQuestionsOutput = document.getElementById('promptShortQuestionsOutput');
        const copyPromptShortQuestionsBtn = document.getElementById('copyPromptShortQuestionsBtn');
        const copyPromptShortMessage = document.getElementById('copyPromptShortMessage');
        const numMCQ = document.getElementById('numMCQ');
        const numChoicesMCQ = document.getElementById('numChoicesMCQ');
        const generatePromptMCQBtn = document.getElementById('generatePromptMCQBtn');
        const promptMCQOutput = document.getElementById('promptMCQOutput');
        const copyPromptMCQBtn = document.getElementById('copyPromptMCQBtn');
        const copyPromptMCQMessage = document.getElementById('copyPromptMCQMessage');
        const generatePromptSummaryBtn = document.getElementById('generatePromptSummaryBtn');
        const promptSummaryOutput = document.getElementById('promptSummaryOutput');
        const copyPromptSummaryBtn = document.getElementById('copyPromptSummaryBtn');
        const copyPromptSummaryMessage = document.getElementById('copyPromptSummaryMessage');
        const numRegroupementZones = document.getElementById('numRegroupementZones');
        const numRegroupementItems = document.getElementById('numRegroupementItems');
        const generatePromptRegroupementBtn = document.getElementById('generatePromptRegroupementBtn');
        const promptRegroupementOutput = document.getElementById('promptRegroupementOutput');
        const copyPromptRegroupementBtn = document.getElementById('copyPromptRegroupementBtn');
        const copyPromptRegroupementMessage = document.getElementById('copyPromptRegroupementMessage');

        const textShortQuestionsInput = document.getElementById('textShortQuestionsInput');
        const convertShortToImageWithCorrectionBtn = document.getElementById('convertShortToImageWithCorrectionBtn');
        const convertShortToImageWithoutCorrectionBtn = document.getElementById('convertShortToImageWithoutCorrectionBtn');
        const exportShortToDocxWithCorrectionBtn = document.getElementById('exportShortToDocxWithCorrectionBtn');
        const exportShortToDocxWithoutCorrectionBtn = document.getElementById('exportShortToDocxWithoutCorrectionBtn');
        const shortQuestionsImage = document.getElementById('shortQuestionsImage');
        const shortQuestionsPlaceholder = document.getElementById('shortQuestionsPlaceholder');
        const downloadShortLink = document.getElementById('downloadShortLink');

        const textMCQInput = document.getElementById('textMCQInput');
        const convertMCQTableBtn = document.getElementById('convertMCQTableBtn');
        const mcqConversionMessage = document.getElementById('mcqConversionMessage');
        const convertMCQToImageWithCorrectionBtn = document.getElementById('convertMCQToImageWithCorrectionBtn');
        const convertMCQToImageWithoutCorrectionBtn = document.getElementById('convertMCQToImageWithoutCorrectionBtn');
        const exportMCQToDocxWithCorrectionBtn = document.getElementById('exportMCQToDocxWithCorrectionBtn');
        const exportMCQToDocxWithoutCorrectionBtn = document.getElementById('exportMCQToDocxWithoutCorrectionBtn');
        const mcqImage = document.getElementById('mcqImage');
        const mcqPlaceholder = document.getElementById('mcqPlaceholder');
        const downloadMcqLink = document.getElementById('downloadMcqLink');

        const convertCombinedToImageWithCorrectionBtn = document.getElementById('convertCombinedToImageWithCorrectionBtn');
        const convertCombinedToImageWithoutCorrectionBtn = document.getElementById('convertCombinedToImageWithoutCorrectionBtn');
        const combinedImage = document.getElementById('combinedImage');
        const combinedPlaceholder = document.getElementById('combinedPlaceholder');
        const downloadCombinedLink = document.getElementById('downloadCombinedLink');

        // Selectors for Section 5 (IDs updated for clarity)
        const existingHtmlCourseCodeInput = document.getElementById('existingHtmlCourseCodeInput'); // Changed ID
        const designColorPrimary = document.getElementById('designColorPrimary');
        const designColorSecondary = document.getElementById('designColorSecondary');
        const designColorAccent = document.getElementById('designColorAccent');
        const designGeneralStyle = document.getElementById('designGeneralStyle');
        const designIconStyle = document.getElementById('designIconStyle');
        const designImageInstructions = document.getElementById('designImageInstructions');
        const designOtherImprovements = document.getElementById('designOtherImprovements');
        const generateDesignModificationPromptBtn = document.getElementById('generateDesignModificationPromptBtn'); // Changed ID
        const designModificationPromptOutput = document.getElementById('designModificationPromptOutput'); // Changed ID
        const copyDesignModificationPromptBtn = document.getElementById('copyDesignModificationPromptBtn'); // Changed ID
        const copyDesignModificationPromptMessage = document.getElementById('copyDesignModificationPromptMessage'); // Changed ID


        // Fonctions utilitaires
        function updateRadioLabelStyle() {
            document.querySelectorAll('.radio-label').forEach(label => {
                const input = label.querySelector('input[type="radio"]');
                if (input.checked) { label.classList.add('selected'); }
                else { label.classList.remove('selected'); }
            });
        }

        function copyToClipboardUtil(text, messageElement, successText = "Copié !") {
            if (!text || text.trim() === "") {
                messageElement.textContent = "Rien à copier.";
                setTimeout(() => { messageElement.textContent = ''; }, 2000);
                return;
            }
            navigator.clipboard.writeText(text).then(() => {
                messageElement.textContent = successText;
            }).catch(err => {
                console.error('Erreur de copie via Clipboard API:', err);
                messageElement.textContent = 'Erreur de copie.';
            }).finally(() => {
                setTimeout(() => { messageElement.textContent = ''; }, 3000);
            });
        }

        function cleanUserInputText(htmlOrText) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlOrText;
            let text = tempDiv.textContent || tempDiv.innerText || "";
            text = text.replace(/\s\s+/g, ' ');
            text = text.split('\n').map(line => line.trim()).filter(line => line.length > 0).join('\n');
            return text.trim();
        }

        // Logique Section 1 & 2 Prompts
        document.querySelectorAll('input[name="outputFormat"]').forEach(radio => {
            radio.addEventListener('change', updateRadioLabelStyle);
        });
        updateRadioLabelStyle();

        gradeSelect.addEventListener('change', function() {
            const selectedGrade = this.value;
            moduleSelect.innerHTML = '<option value="">-- Choisir un module --</option>';
            outputPrompt.value = ''; copyMessage.textContent = '';
            pedagogicalOutput.value = ''; pedagogicalOutputLabel.textContent = 'Sortie des outils annexes :';
            copyPedagogicalOutputMessage.textContent = '';

            if (selectedGrade && modulesData[selectedGrade]) {
                moduleSelect.disabled = false;
                const gradeModules = modulesData[selectedGrade];
                Object.keys(gradeModules).sort((a,b) => parseInt(a) - parseInt(b)).forEach(moduleKey => {
                     const moduleInfo = gradeModules[moduleKey];
                     if (moduleInfo) {
                        const option = document.createElement('option');
                        option.value = moduleKey;
                        option.textContent = `Module ${moduleKey}: ${moduleInfo.title}`;
                        moduleSelect.appendChild(option);
                    }
                });
            } else {
                moduleSelect.disabled = true;
            }
        });

        moduleSelect.addEventListener('change', function() {
            outputPrompt.value = ''; copyMessage.textContent = '';
            pedagogicalOutput.value = ''; pedagogicalOutputLabel.textContent = 'Sortie des outils annexes :';
            copyPedagogicalOutputMessage.textContent = '';
        });

        generateButton.addEventListener('click', function() {
            const selectedGrade = gradeSelect.value;
            const selectedModuleNumber = moduleSelect.value;
            const studentThemes = studentThemesInput.value.trim();
            const selectedFormat = document.querySelector('input[name="outputFormat"]:checked').value;

            if (!selectedGrade) { alert("Veuillez sélectionner un niveau."); return; }
            if (!selectedModuleNumber) { alert("Veuillez sélectionner un module."); return; }
            if (!studentThemes) { alert("Veuillez renseigner les thèmes chers aux élèves."); return; }

            const moduleDetails = modulesData[selectedGrade]?.[selectedModuleNumber];
            if (!moduleDetails) { alert("Détails du module non trouvés. Vérifiez les données `modulesData`."); return; }

            let formatSpecificInstructions = "";
            let targetAudienceFocus = "";
            // Le placeholder <!-- DESIGN_DIRECTIVES_PLACEHOLDER --> n'est plus nécessaire ici
            // car la section 5 génère un prompt séparé pour modifier un HTML existant.

            if (selectedFormat === "docx") {
                targetAudienceFocus = `Le document final est destiné à être un support de cours de référence pour les élèves et une base pour l'enseignant. Il doit être facilement convertible au format DOCX.`;
                formatSpecificInstructions = `
**Consignes spécifiques pour la sortie DOCX :**
* **Mise en page :** Structurer le contenu avec des titres clairs (Niveau 1 pour le titre du module, Niveau 2 pour les grandes parties comme Introduction, Développement, etc., Niveau 3 pour les chapitres du développement). Utiliser des listes à puces ou numérotées pour les énumérations. Prévoir des espaces pour d'éventuelles images ou schémas qui seraient ajoutés manuellement dans le DOCX.
* **Qualité :** Viser un document de qualité professionnelle, avec une typographie lisible et une présentation aérée et harmonieuse. Le langage doit rester académique tout en étant accessible.
* **Contenu :** Assurer la complétude et la rigueur des informations techniques. Les schémas textuels doivent être suffisamment descriptifs pour guider la création graphique ultérieure.
`;
            } else if (selectedFormat === "html") {
                targetAudienceFocus = `La page web est destinée à être une ressource interactive et captivante pour des élèves de collège (12-15 ans). Elle doit être consultable sur différents appareils (responsive design).`;
                formatSpecificInstructions = `
**Consignes spécifiques pour la sortie Page Web (HTML unique) :**
* **Fichier Unique :** Tout le code (HTML, CSS, JavaScript) doit être contenu dans un seul fichier HTML.
* **Design Moderne et Engageant (Baseline) :**
    * Utiliser un design visuellement attrayant, moderne et adapté à un public adolescent.
    * Intégrer des **pictogrammes** (SVG de préférence, ou emojis pertinents) pour illustrer les concepts clés et aérer le texte.
    * Utiliser des **effets visuels et animations** subtils pour rendre la navigation et la lecture plus dynamiques, sans surcharger.
    * Prévoir des **interactions** simples (ex: éléments cliquables pour révéler plus d'informations, infobulles pour les termes du glossaire).
* **Structure HTML Sémantique :** Utiliser des balises HTML5 sémantiques (<header>, <nav>, <main>, <article>, <section>, <aside>, <footer>).
* **CSS Intégré :** Placer tout le CSS dans des balises <style> dans le <head> du document. Utiliser des classes pour styliser les éléments.
* **JavaScript Intégré :** Placer tout le JavaScript dans des balises <script> à la fin du <body> (ou dans le <head> avec l'attribut 'defer'). Le JS sera nécessaire pour les interactions et les exercices auto-corrigés.
* **Accessibilité :** Tenir compte des bases de l'accessibilité web (contrastes suffisants, alternatives textuelles pour les images si des placeholders sont utilisés, navigation clavier possible pour les éléments interactifs).
* **Pied de page du cours HTML :** Le pied de page de la page web générée doit contenir le texte "Technologie Collège".

**Section "Exercices d'entraînement" (Obligatoire pour la page web) :**
À la fin du module, intégrer une section d'exercices hautement interactifs et auto-corrigés pour permettre aux élèves de tester leur compréhension. Au total, la section doit proposer **au moins 10 exercices interactifs variés**.
    1.  **QCM (Questions à Choix Multiples) :** Plusieurs QCM (au moins 3-4) avec 3 ou 4 options de réponse. L'élève sélectionne une réponse, et un feedback immédiat (visuel et textuel : correct/incorrect, avec explication si incorrect) est fourni.
    2.  **Exercices de Correspondance :** Plusieurs exercices de correspondance (au moins 2-3) où l'élève doit faire correspondre des éléments de deux listes. L'interaction peut se faire par glisser-déposer ou sélection. Feedback immédiat et visuel.
    3.  **Questions à Réponse Simple/Courte :** Plusieurs questions (au moins 2-3) où l'élève doit taper une réponse courte. Prévoir une vérification (tolérance aux variations). **Chaque question DOIT inclure un bouton "Afficher l'aide/indice"**. Feedback immédiat.
    4.  **Autres types d'exercices interactifs (pour atteindre 10 et varier) :** Inclure par exemple : "remettre des étapes dans l'ordre" (glisser-déposer), "texte à trous", petit "vrai ou faux" interactif.
    * **Interactivité et Feedback :** Essentiel. Animations discrètes. Permettre de réessayer. Score global souhaitable.
    * **Interface Claire et Ludique :** Intuitive, touche ludique pour engagement.
`;
            }

            const promptTemplate = `Agissez en tant qu'expert en ingénierie pédagogique spécialisé en technologie collège ET en conception de supports ${selectedFormat === 'docx' ? 'documentaires (DOCX)' : 'web interactifs (HTML/CSS/JS)'}.
Je suis enseignant de technologie au niveau ${selectedGrade} et je souhaite que vous construisiez le module ${selectedModuleNumber} intitulé "${moduleDetails.title}".
${targetAudienceFocus}

**Format de Sortie Demandé : ${selectedFormat === 'docx' ? 'Document (préparé pour DOCX)' : 'Page Web (HTML unique avec CSS/JS intégrés)'}**

**Structure Générale du Module :**

1.  **Introduction percutante (environ 150 mots) :**
    * Commencer par la phrase d'accroche : "${moduleDetails.hook}"
    * Présenter les objectifs d'apprentissage liés aux compétences : "${moduleDetails.skills}"
    * Annoncer clairement les connaissances visées : "${moduleDetails.knowledge}"

2.  **Développement structuré en 3 chapitres minimum (subdivisions du module) (### niveau de titre Markdown pour la structure de base) :**
    * Chaque chapitre doit traiter d'un aspect technique fondamental.
    * Intégrer pour chaque concept clé :
        * Explications claires, analogies avec le quotidien des élèves.
        * Description textuelle détaillée d'un schéma/illustration (pour DOCX) ou suggestion d'icône/schéma simple (pour HTML).
        * Au moins 2 exemples concrets liés à : ${studentThemes}.

3.  **Encarts "Le saviez-vous ?" (Au moins un par chapitre, répartis) :**
    * Fait historique/technologique surprenant, application industrielle, perspective écologique/sociétale.
    * (Pour HTML : stylisation distincte, ex: boîtes colorées, icônes).

4.  **Section "Perspectives et Avenir" (### niveau de titre Markdown) :**
    * Innovations R&D.
    * Métiers émergents.
    * Enjeux éthiques/pratiques (horizon 2030-2040).

5.  **Conclusion synthétique (environ 100 mots) :**
    * Résumé visuel (carte mentale textuelle pour DOCX) ou liste à puces récapitulative (pour HTML, potentiellement interactive).
    * Question ouverte pour débat.
    * Lien avec module suivant (si pertinent).

6.  **Glossaire (10 termes techniques minimum) :**
    * Définitions adaptées au niveau ${selectedGrade}. Étymologie si possible.
    * (Pour HTML : termes cliquables pour afficher définition).

**Consignes Rédactionnelles Générales :**
* **Langage :** Niveau ${selectedGrade} collège, jargon technique expliqué.
* **Exemples :** 70% issus de : ${studentThemes}.
* **Compliance :** Alignement avec programme officiel.

${formatSpecificInstructions}

---
Fin du prompt pour le module "${moduleDetails.title}" (${selectedGrade}), format ${selectedFormat}.
---`;
            outputPrompt.value = promptTemplate;
            outputPrompt.scrollTop = 0;
            copyMessage.textContent = '';
        });

        copyButton.addEventListener('click', () => copyToClipboardUtil(outputPrompt.value, copyMessage, "Prompt Module copié !"));

        logbookButton.addEventListener('click', function() {
            const selectedGrade = gradeSelect.value;
            const selectedModuleNumber = moduleSelect.value;
            if (!selectedGrade || !selectedModuleNumber) { alert("Veuillez d'abord sélectionner un niveau et un module."); pedagogicalOutput.value = "Sélectionnez un niveau et un module."; pedagogicalOutputLabel.textContent = 'Sortie : Erreur'; return; }
            const moduleDetails = modulesData[selectedGrade]?.[selectedModuleNumber];
            if (!moduleDetails) { pedagogicalOutput.value = "Détails du module non trouvés."; pedagogicalOutputLabel.textContent = 'Sortie : Erreur'; return; }
            const logbookEntry = `Module ${selectedModuleNumber} : ${moduleDetails.title}\nContenu de la séance : ${moduleDetails.hook}\nCompétences clés visées : ${moduleDetails.skills}.\nNotions essentielles abordées : ${moduleDetails.knowledge}.\nTravail à faire / Observations : `;
            pedagogicalOutput.value = logbookEntry;
            pedagogicalOutputLabel.textContent = 'Sortie : Proposition pour Cahier de Texte';
            copyPedagogicalOutputMessage.textContent = '';
        });

        summaryButton.addEventListener('click', function() {
            const selectedGrade = gradeSelect.value;
            const selectedModuleNumber = moduleSelect.value;
            if (!selectedGrade || !selectedModuleNumber) { alert("Veuillez d'abord sélectionner un niveau et un module."); pedagogicalOutput.value = "Sélectionnez un niveau et un module."; pedagogicalOutputLabel.textContent = 'Sortie : Erreur'; return; }
            const moduleDetails = modulesData[selectedGrade]?.[selectedModuleNumber];
            if (!moduleDetails) { pedagogicalOutput.value = "Détails du module non trouvés."; pedagogicalOutputLabel.textContent = 'Sortie : Erreur'; return; }

            let mainObjective = moduleDetails.hook.replace(/^Comment\s+|^Pourquoi\s+|^De quoi\s+sont\s+faits\s+les\s+objets\s+qui\s+nous\s+entourent\s*\?\s*|^De quoi\s+|^Quelles\s+sont\s+les\s+|^Quel\s+rôle\s+|^Comment\s+les\s+/, '');
            mainObjective = mainObjective.charAt(0).toLowerCase() + mainObjective.slice(1);
            if (mainObjective.endsWith('?')) { mainObjective = mainObjective.slice(0, -1).trim(); }

            const knowledgeTerms = moduleDetails.knowledge.split(',').map(term => term.trim().toLowerCase());
            let keyTermsString = "";
            if (knowledgeTerms.length > 0) {
                keyTermsString = `Vous allez découvrir des notions importantes comme "${knowledgeTerms[0]}"`;
                if (knowledgeTerms.length > 1) { keyTermsString += `, "${knowledgeTerms[1]}"`; }
                if (knowledgeTerms.length > 2) { keyTermsString += ` et aussi "${knowledgeTerms[2]}"`; }
                keyTermsString += ".";
            }
            const firstSkill = moduleDetails.skills.toLowerCase().split(',')[0].trim();
            const summaryText = `Bienvenue dans le module "${moduleDetails.title}" !\nAu cours des prochaines séances, nous allons ensemble explorer ${mainObjective}.\nVous apprendrez à ${firstSkill}. ${keyTermsString}\nCe module vous aidera à mieux comprendre comment fonctionnent les objets techniques qui vous entourent et à développer votre regard critique sur la technologie.\nNous utiliserons des exemples de votre quotidien pour rendre l'apprentissage plus concret.\nPréparez-vous à analyser, à concevoir et à mieux comprendre le monde technologique !`;
            pedagogicalOutput.value = summaryText;
            pedagogicalOutputLabel.textContent = 'Sortie : Résumé du Module (pour les élèves)';
            copyPedagogicalOutputMessage.textContent = '';
        });
        copyPedagogicalOutputButton.addEventListener('click', () => copyToClipboardUtil(pedagogicalOutput.value, copyPedagogicalOutputMessage, "Texte annexe copié !"));

        if (gradeSelect.value) { gradeSelect.dispatchEvent(new Event('change')); }

        generatePromptShortQuestionsBtn.addEventListener('click', () => {
            const courseContent = cleanUserInputText(courseContentInputForExercises.value);
            const numQuestions = numShortQuestions.value;
            if (!courseContent) {
                alert("Veuillez coller le contenu du cours (dans la grande zone de texte de la section 2) pour générer les prompts d'exercices.");
                courseContentInputForExercises.focus();
                return;
            }
            const prompt = `En te basant STRICTEMENT sur le contenu de cours suivant :
--- DEBUT CONTENU COURS ---
${courseContent}
--- FIN CONTENU COURS ---

NOTE IMPORTANTE DE CONTEXTE : Pour la tâche demandée ci-dessous, tu dois te baser EXCLUSIVEMENT sur la portion du "CONTENU COURS" (ci-dessus) qui se situe APRÈS une éventuelle introduction générale et AVANT une éventuelle section "Glossaire". Si ces sections (Introduction, Glossaire) ne sont pas clairement marquées, considère que le contenu pertinent est le corps principal du texte, excluant les titres de module très généraux au début et les listes de définitions à la toute fin. L'objectif est de travailler sur le contenu développé du cours, typiquement organisé en chapitres ou sections thématiques, incluant les conclusions ou perspectives si elles précèdent le glossaire.

Génère exactement ${numQuestions} questions distinctes. Ces questions doivent porter sur les thèmes et concepts importants explicitement présents dans CETTE PORTION SPÉCIFIQUE du cours fourni.
Chaque question doit être formulée pour attendre IMPÉRATIVEMENT UNE RÉPONSE EN UN SEUL MOT. La réponse que tu fournis pour chaque question doit être ce mot unique, directement issu du cours.

**Consignes sur la formulation des questions :**
* La question doit être une **phrase interrogative complète, claire et explicite**.
* Elle doit guider l'élève vers la réponse unique attendue, sans être ambiguë ou trop laconique (par exemple, évite les questions comme "Mot-clé ?" ou "Concept principal ?").
* Formule la question de manière à ce qu'un élève puisse comprendre précisément ce qui est demandé pour fournir le mot unique. La question ne doit pas elle-même contenir des indices trop évidents sur la réponse.

**Format de sortie impératif pour chaque item** (chaque question et sa réponse sur une nouvelle ligne, séparées par " :: ") :
Phrase interrogative complète et explicite ? :: RéponseEnUnSeulMot (directement issue du cours)`;
            promptShortQuestionsOutput.value = prompt;
            promptShortQuestionsOutput.scrollTop = 0;
        });
        copyPromptShortQuestionsBtn.addEventListener('click', () => copyToClipboardUtil(promptShortQuestionsOutput.value, copyPromptShortMessage, "Prompt (Quest. Courtes) copié !"));

        generatePromptMCQBtn.addEventListener('click', () => {
            const courseContent = cleanUserInputText(courseContentInputForExercises.value);
            const numQCMs = numMCQ.value;
            const numChoices = parseInt(numChoicesMCQ.value);

            if (!courseContent) {
                alert("Veuillez coller le contenu du cours (grande zone de texte section 2) pour générer les prompts d'exercices.");
                courseContentInputForExercises.focus();
                return;
            }

            let headerColumns = "| Question ";
            let separatorLine = "|:-------";
            let exampleRow = "| Exemple de question ? ";
            const optionLetters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            for (let i = 0; i < numChoices; i++) {
                headerColumns += `| Proposition ${optionLetters[i]} `;
                separatorLine += "|:--------------------";
                exampleRow += `| Option ${optionLetters[i]} exemple `;
            }
            headerColumns += "| Bonne réponse (Lettre) |";
            separatorLine += "|:-----------------------|";
            exampleRow += `| B                      |`;


            const prompt = `En te basant STRICTEMENT sur le contenu de cours suivant :
--- DEBUT CONTENU COURS ---
${courseContent}
--- FIN CONTENU COURS ---

NOTE IMPORTANTE DE CONTEXTE : Pour la tâche demandée ci-dessous, tu dois te baser EXCLUSIVEMENT sur la portion du "CONTENU COURS" (ci-dessus) qui se situe APRÈS une éventuelle introduction générale et AVANT une éventuelle section "Glossaire". Si ces sections (Introduction, Glossaire) ne sont pas clairement marquées, considère que le contenu pertinent est le corps principal du texte, excluant les titres de module très généraux au début et les listes de définitions à la toute fin.

Génère exactement ${numQCMs} QCM (Questions à Choix Multiples) distincts et pertinents, basés uniquement sur les informations explicitement présentes dans CETTE PORTION SPÉCIFIQUE du cours fourni.
Chaque QCM doit avoir exactement ${numChoices} propositions de réponse. Une seule doit être correcte.
Les distracteurs doivent être plausibles mais incorrects, tirés ou inspirés du contexte de CETTE PORTION SPÉCIFIQUE du cours.

**FORMAT DE SORTIE IMPÉRATIF : Tableau Markdown**
Tu dois présenter les QCM sous la forme d'un unique tableau Markdown.
Le tableau doit avoir les colonnes suivantes, dans cet ordre :
1.  **Question** : Le texte de la question.
2.  **Proposition A** : Le texte de la première proposition.
3.  **Proposition B** : Le texte de la deuxième proposition.
${numChoices >= 3 ? "4.  **Proposition C** : Le texte de la troisième proposition." : ""}
${numChoices >= 4 ? "5.  **Proposition D** : Le texte de la quatrième proposition." : ""}
${numChoices === 3 ? "4.  **Bonne réponse (Lettre)** : La lettre (A, B, ou C) de la proposition correcte." : ""}
${numChoices === 4 ? "6.  **Bonne réponse (Lettre)** : La lettre (A, B, C, ou D) de la proposition correcte." : ""}


**Exemple de structure du tableau Markdown attendu (pour ${numChoices} propositions) :**
${headerColumns}
${separatorLine}
${exampleRow}
| Une autre question ici...              | Prop A                 | Prop B                 | ${numChoices >=3 ? 'Prop C' : ''}                 | ${numChoices >=4 ? 'Prop D' : ''}                 | C                      |
... (autant de lignes que de QCM demandés, soit ${numQCMs} QCM au total)

**Consignes importantes pour le tableau :**
*   Ne PAS inclure de numéro de QCM dans une colonne séparée "Numéro" ou "#". Numérote simplement les questions dans la colonne "Question" si tu le souhaites (ex: "1. Ma question ?").
*   Assure-toi que chaque QCM est sur une seule ligne du tableau.
*   La colonne "Bonne réponse (Lettre)" doit contenir UNIQUEMENT la lettre majuscule (A, B, C, D etc.) correspondant à la bonne proposition pour cette ligne.
*   N'ajoute PAS de séparateurs "---" entre les lignes de QCM dans le tableau. Le format tableau Markdown gère cela.

ATTENTION LE TABLEAU DOIT ETRE CODé EN MARKDOWN`;
            promptMCQOutput.value = prompt;
            promptMCQOutput.scrollTop = 0;
        });
        copyPromptMCQBtn.addEventListener('click', () => copyToClipboardUtil(promptMCQOutput.value, copyPromptMCQMessage, "Prompt (QCM) copié !"));

        generatePromptSummaryBtn.addEventListener('click', () => {
            const courseContent = cleanUserInputText(courseContentInputForExercises.value);
            if (!courseContent) {
                alert("Veuillez coller le contenu du cours (grande zone de texte section 2) pour générer le prompt de résumé.");
                courseContentInputForExercises.focus();
                return;
            }
            const prompt = `En te basant STRICTEMENT sur le contenu de cours suivant :
--- DEBUT CONTENU COURS ---
${courseContent}
--- FIN CONTENU COURS ---

NOTE IMPORTANTE DE CONTEXTE : La tâche demandée ci-dessous (rédiger un résumé) doit porter EXCLUSIVEMENT sur la portion du "CONTENU COURS" (ci-dessus) qui se situe APRÈS une éventuelle introduction générale et AVANT une éventuelle section "Glossaire". Si ces sections (Introduction, Glossaire) ne sont pas clairement marquées, considère que le contenu pertinent est le corps principal du texte, excluant les titres de module très généraux au début et les listes de définitions à la toute fin. L'objectif est de résumer le contenu développé du cours, typiquement organisé en chapitres ou sections thématiques, incluant les conclusions ou perspectives si elles précèdent le glossaire.

Rédige un résumé concis et informatif de CETTE PORTION SPÉCIFIQUE du cours en environ 180 mots.
Le résumé doit capturer les idées principales, les concepts clés et les informations essentielles présentées dans CETTE PORTION SPÉCIFIQUE du texte.
Assure-toi que le résumé est fluide, cohérent et facile à comprendre.
Ne te base que sur les informations fournies dans CETTE PORTION SPÉCIFIQUE du texte du cours.
Le résultat doit être uniquement le texte du résumé, sans introduction ni conclusion de ta part à propos du résumé lui-même.`;
            promptSummaryOutput.value = prompt;
            promptSummaryOutput.scrollTop = 0;
        });
        copyPromptSummaryBtn.addEventListener('click', () => copyToClipboardUtil(promptSummaryOutput.value, copyPromptSummaryMessage, "Prompt (Résumé) copié !"));

        generatePromptRegroupementBtn.addEventListener('click', () => {
            const courseContent = cleanUserInputText(courseContentInputForExercises.value);
            const numZones = parseInt(numRegroupementZones.value);
            const numItems = parseInt(numRegroupementItems.value);

            if (!courseContent) {
                alert("Veuillez coller le contenu du cours (grande zone de texte section 2) pour générer le prompt de regroupement.");
                courseContentInputForExercises.focus();
                return;
            }
            if (isNaN(numZones) || numZones < 2 || numZones > 4) {
                alert("Veuillez entrer un nombre de zones valide (entre 2 et 4).");
                numRegroupementZones.focus();
                return;
            }
            if (isNaN(numItems) || numItems < 3 || numItems > 8) {
                alert("Veuillez entrer un nombre d'éléments par zone valide (entre 3 et 8).");
                numRegroupementItems.focus();
                return;
            }

            const prompt = `En te basant STRICTEMENT sur le contenu de cours suivant :
--- DEBUT CONTENU COURS ---
${courseContent}
--- FIN CONTENU COURS ---

NOTE IMPORTANTE DE CONTEXTE : Pour la tâche demandée ci-dessous, tu dois te baser EXCLUSIVEMENT sur la portion du "CONTENU COURS" (ci-dessus) qui se situe APRÈS une éventuelle introduction générale et AVANT une éventuelle section "Glossaire". Si ces sections (Introduction, Glossaire) ne sont pas clairement marquées, considère que le contenu pertinent est le corps principal du texte, excluant les titres de module très généraux au début et les listes de définitions à la toute fin. L'objectif est de travailler sur le contenu développé du cours, typiquement organisé en chapitres ou sections thématiques, incluant les conclusions ou perspectives si elles précèdent le glossaire.

Crée un exercice de regroupement (ou de classification) basé sur CETTE PORTION SPÉCIFIQUE du cours. Pour cela :
1.  Identifie ${numZones} thèmes ou catégories principaux et distincts abordés dans CETTE PORTION SPÉCIFIQUE du cours. Donne un titre clair et concis à chacune de ces ${numZones} zones de regroupement.
2.  Pour chaque zone, sélectionne ${numItems} mots-clés ou expressions courtes (2-4 mots maximum) directement issus ou très fortement inspirés du contenu de CETTE PORTION SPÉCIFIQUE du cours, qui appartiennent sans ambiguïté à cette zone/catégorie. Au total, il y aura donc ${numZones * numItems} éléments à classer.
3.  Présente le résultat de la manière suivante :
    * D'abord, la liste des ${numZones * numItems} mots/expressions à classer, mélangés.
    * Ensuite, les titres des ${numZones} zones de regroupement.
    * Enfin, la solution claire indiquant quels mots/expressions vont dans chaque zone.

Exemple de format de sortie attendu (adapte le contenu à la demande) :

Éléments à classer :
[Liste de tous les ${numZones * numItems} mots/expressions mélangés, séparés par des virgules ou sur des lignes séparées]

Zones de regroupement :
Zone 1 : [Titre de la zone 1]
Zone 2 : [Titre de la zone 2]
${numZones >= 3 ? "Zone 3 : [Titre de la zone 3]" : ""}
${numZones >= 4 ? "Zone 4 : [Titre de la zone 4]" : ""}

Solution :
Zone 1 : [Titre de la zone 1]
    - [Élément 1.1]
    - [Élément 1.2]
    - ... (jusqu'à ${numItems} éléments)
Zone 2 : [Titre de la zone 2]
    - [Élément 2.1]
    - [Élément 2.2]
    - ... (jusqu'à ${numItems} éléments)
${numZones >= 3 ? `Zone 3 : [Titre de la zone 3]\n    - [Élément 3.1]\n    - ... (jusqu'à ${numItems} éléments)` : ""}
${numZones >= 4 ? `Zone 4 : [Titre de la zone 4]\n    - [Élément 4.1]\n    - ... (jusqu'à ${numItems} éléments)` : ""}

Assure-toi que tous les éléments et titres de zones sont directement pertinents par rapport à CETTE PORTION SPÉCIFIQUE du contenu du cours fourni.`;
            promptRegroupementOutput.value = prompt;
            promptRegroupementOutput.scrollTop = 0;
        });
        copyPromptRegroupementBtn.addEventListener('click', () => copyToClipboardUtil(promptRegroupementOutput.value, copyPromptRegroupementMessage, "Prompt (Regroupement) copié !"));

        // Helper pour parser une ligne de tableau Markdown
        function parseMarkdownTableRow(rowString) {
            if (!rowString.trim().startsWith('|') || !rowString.trim().endsWith('|')) {
                 return null;
            }
            return rowString.slice(1, -1).split('|').map(cell => cell.trim());
        }

        function convertMarkdownTableToMCQTextFormat() {
            const rawText = textMCQInput.value.trim();
            const lines = rawText.split('\n').map(l => l.trim()).filter(line => line.length > 0 && line.includes('|'));
            const numChoicesExpected = parseInt(document.getElementById('numChoicesMCQ').value);

            let outputText = "";
            let qcmConvertedCount = 0;
            let errors = [];

            if (lines.length === 0) {
                mcqConversionMessage.textContent = "Aucun contenu de tableau Markdown détecté.";
                mcqConversionMessage.className = 'conversion-message conversion-error';
                return;
            }

            let headerSkipped = false;
            let isFirstDataRow = true;

            lines.forEach((line, lineIndex) => {
                if (line.startsWith('|--') || line.match(/^\|\s*:?-+:?\s*\|/)) {
                    headerSkipped = true;
                    return;
                }
                if (!headerSkipped && isFirstDataRow && line.toLowerCase().includes("question")) {
                     headerSkipped = true;
                     isFirstDataRow = false;
                     return;
                }
                isFirstDataRow = false;

                const cells = parseMarkdownTableRow(line);
                if (!cells) {
                    errors.push(`Ligne #${lineIndex + 1} ignorée (pas un format de cellule Markdown valide).`);
                    return;
                }

                const expectedMinCells = 1 + numChoicesExpected + 1;
                let question, correctAnswerLetter;
                let options = [];
                let cellOffset = 0;

                if (cells.length > expectedMinCells && /^\d+\.?$/.test(cells[0]) && cells[1] && cells[1].length > 2) {
                     cellOffset = 1;
                }

                if (cells.length < expectedMinCells - cellOffset) {
                     errors.push(`Ligne #${lineIndex + 1}: Nombre de colonnes insuffisant (${cells.length}). Attendu au moins ${expectedMinCells - cellOffset} (après N° optionnel). Ligne: "${line.substring(0,50)}..."`);
                     return;
                }

                question = cells[cellOffset];
                if (!question || question.length < 3) {
                    errors.push(`Ligne #${lineIndex + 1}: Question invalide ou manquante. Ligne: "${line.substring(0,50)}..."`);
                    return;
                }

                for (let i = 0; i < numChoicesExpected; i++) {
                    const optionCellIndex = cellOffset + 1 + i;
                    if (cells[optionCellIndex] !== undefined && cells[optionCellIndex].trim() !== "") {
                        options.push(cells[optionCellIndex].trim());
                    } else {
                        options.push(`Option ${String.fromCharCode(65 + i)} manquante`);
                        errors.push(`Ligne #${lineIndex + 1}: Option ${String.fromCharCode(65 + i)} manquante ou vide.`);
                    }
                }

                correctAnswerLetter = cells[cellOffset + 1 + numChoicesExpected]?.trim().toUpperCase().charAt(0);

                if (!correctAnswerLetter || !/^[A-Z]$/.test(correctAnswerLetter) || correctAnswerLetter.charCodeAt(0) - 65 >= numChoicesExpected ) {
                    errors.push(`Ligne #${lineIndex + 1}: Lettre de bonne réponse ("${correctAnswerLetter}") invalide ou hors de portée pour ${numChoicesExpected} options. Ligne: "${line.substring(0,50)}..."`);
                    const lastCell = cells[cells.length -1]?.trim().toUpperCase().charAt(0);
                    if(lastCell && /^[A-Z]$/.test(lastCell) && lastCell.charCodeAt(0) - 65 < numChoicesExpected) {
                            correctAnswerLetter = lastCell;
                            errors.push(`   (Utilisation de la dernière cellule "${lastCell}" comme alternative pour la bonne réponse)`);
                    } else {
                            return;
                    }
                }

                outputText += `${question}\n`;
                options.forEach((opt, idx) => {
                    outputText += `${String.fromCharCode(65 + idx)}) ${opt}\n`;
                });
                outputText += `Bonne réponse : ${correctAnswerLetter}\n`;
                outputText += "---\n";
                qcmConvertedCount++;
            });

            if (qcmConvertedCount > 0) {
                textMCQInput.value = outputText.trim();
                mcqConversionMessage.textContent = `${qcmConvertedCount} QCM convertis avec succès depuis le tableau.`;
                if(errors.length > 0) mcqConversionMessage.textContent += ` (${errors.length} avertissements/erreurs mineures, voir console pour détails).`;
                mcqConversionMessage.className = 'conversion-message conversion-success';
                if (errors.length > 0) console.warn("Avertissements/erreurs mineures durant la conversion du tableau QCM:\n" + errors.join("\n"));

            } else {
                mcqConversionMessage.textContent = "Aucun QCM valide n'a pu être converti depuis le tableau.";
                if(errors.length > 0) mcqConversionMessage.textContent += ` Erreurs: ${errors.join('; ')}. (Voir console pour plus de détails).`;
                else mcqConversionMessage.textContent += " Vérifiez le format du tableau (nombre de colonnes, etc.)."
                mcqConversionMessage.className = 'conversion-message conversion-error';
                 if (errors.length > 0) console.error("Erreurs durant la conversion du tableau QCM:\n" + errors.join("\n"));
            }
             setTimeout(() => { mcqConversionMessage.textContent = ''; }, 8000);
        }

        function parseExerciseText(rawText, exerciseType, showCorrection) {
            const parsedItems = [];
            if (exerciseType === 'short') {
                const lines = rawText.split('\n').filter(line => line.trim() !== "");
                lines.forEach((line, index) => {
                    const parts = line.split('::');
                    if (parts.length === 2) {
                        parsedItems.push({
                            type: 'short',
                            data: { question: parts[0].trim(), answer: parts[1].trim() }
                        });
                    } else if (line.trim()) {
                        parsedItems.push({
                            type: 'short',
                            data: { question: line.trim(), answer: "Format incorrect : '::' manquant ou mal placé." },
                            error: true
                        });
                    }
                });
            } else if (exerciseType === 'mcq') {
                const qcmBlocks = rawText.split(/\s*\n\s*---\s*\n\s*/gm).map(b => b.trim()).filter(block => block.length > 0);
                if (qcmBlocks.length === 0 && rawText.length > 0) {
                     parsedItems.push({
                        type: 'mcq',
                        parsingError: "Format QCM non reconnu. Aucun séparateur '---' valide trouvé. Si vous avez collé un tableau, utilisez d'abord le bouton 'Convertir Tableau en Format QCM'."
                    });
                } else {
                    qcmBlocks.forEach((block, blockIndex) => {
                        const blockLines = block.trim().split('\n').filter(l => l.trim() !== '');
                        if (blockLines.length < 2) {
                            parsedItems.push({ type: 'mcq', originalBlock: block, parsingError: `Bloc QCM #${blockIndex + 1} est trop court.`});
                            return;
                        }
                        let questionText = "";
                        let options = [];
                        let correctAnswerLetter = null;
                        let parsingErrorMessage = null;
                        let correctionLineFound = false;
                        questionText = blockLines[0].trim().replace(/^\d+\.\s*/, '');

                        for (let i = 1; i < blockLines.length; i++) {
                            const currentLine = blockLines[i].trim();
                            const lowerLine = currentLine.toLowerCase();
                            if (lowerLine.startsWith("bonne réponse :") || lowerLine.startsWith("correct :")) {
                                const parts = currentLine.split(':');
                                if (parts.length > 1) {
                                    correctAnswerLetter = parts[1].trim().toUpperCase().charAt(0);
                                } else {
                                    parsingErrorMessage = `Format de correction invalide: "${currentLine}".`;
                                }
                                correctionLineFound = true;
                                break;
                            } else if (currentLine) {
                                options.push(currentLine.replace(/^[A-Z][).]\s*/i, '').trim());
                            }
                        }

                        if (!correctionLineFound && !parsingErrorMessage) parsingErrorMessage = `Ligne de correction (ex: "Bonne réponse : A") non trouvée.`;
                        if (options.length < 2 && !parsingErrorMessage) parsingErrorMessage = `Moins de 2 options trouvées avant la ligne de correction.`;
                        if (correctAnswerLetter && !/^[A-Z]$/.test(correctAnswerLetter) && !parsingErrorMessage) {
                            parsingErrorMessage = `Lettre de correction invalide ("${correctAnswerLetter}"). Elle doit être une seule lettre (A, B, C...).`;
                            correctAnswerLetter = null;
                        } else if (correctAnswerLetter && options.length > 0 && (correctAnswerLetter.charCodeAt(0) - 65 >= options.length)) {
                            parsingErrorMessage = `Lettre de correction ("${correctAnswerLetter}") hors de portée pour le nombre d'options (${options.length}).`;
                            correctAnswerLetter = null;
                        }

                        if (parsingErrorMessage) {
                            parsedItems.push({ type: 'mcq', originalBlock: block, parsingError: `QCM #${blockIndex + 1}: ${parsingErrorMessage}` });
                        } else {
                            parsedItems.push({
                                type: 'mcq',
                                data: { question: questionText, options: options, correctAnswerLetter: correctAnswerLetter }
                            });
                        }
                    });
                }
            }
            return parsedItems;
        }

        function buildExerciseHtml(parsedItems, showCorrection, exerciseType, title) {
            let sectionHtml = `<h3>${title}</h3><ul>`;
            let itemCounter = 0;
            parsedItems.forEach((item) => {
                itemCounter++;
                const li = document.createElement('li');
                li.classList.add('question-item');
                let currentItemHtml = "";

                if (item.type === 'short') {
                    currentItemHtml = `<div class="question-text">${itemCounter}. ${item.data.question || 'Question non définie'}</div>`;
                    if (item.error) {
                         currentItemHtml += `<div class="mcq-parsing-error-note">${item.data.answer}</div>`;
                    } else if (showCorrection) {
                        currentItemHtml += `<div class="answer-text">Réponse attendue : ${item.data.answer || 'Réponse non définie'}</div>`;
                    }
                } else if (item.type === 'mcq') {
                    if (item.parsingError) {
                        currentItemHtml = `<div class="mcq-question-block"><div class="mcq-question-text">${itemCounter}. Erreur de parsing du QCM</div>`;
                        if (item.originalBlock) {
                             currentItemHtml += `<pre style="white-space:pre-wrap; font-size:0.8em; color: #555;">Bloc QCM original:\n${item.originalBlock.substring(0,150)}${item.originalBlock.length > 150 ? '...' : ''}</pre>`;
                        }
                        currentItemHtml += `<div class="mcq-parsing-error-note">${item.parsingError}</div>`;
                    } else {
                        currentItemHtml = `<div class="mcq-question-block">`;
                        currentItemHtml += `<div class="mcq-question-text">${itemCounter}. ${item.data.question || 'Question non définie'}</div>`;

                        if (item.data.options && item.data.options.length > 0) {
                            currentItemHtml += `<ul class="mcq-options-list">`;
                            item.data.options.forEach(optText => {
                                currentItemHtml += `<li>${optText || 'Option non définie'}</li>`;
                            });
                            currentItemHtml += `</ul>`;
                        } else {
                            currentItemHtml += `<div class="mcq-parsing-error-note">Aucune option à afficher.</div>`;
                        }

                        if (showCorrection && item.data.correctAnswerLetter) {
                            currentItemHtml += `<div class="mcq-correction-text">Bonne réponse : ${item.data.correctAnswerLetter}</div>`;
                        } else if (showCorrection && !item.data.correctAnswerLetter && !item.parsingError) {
                           currentItemHtml += `<div class="mcq-correction-text" style="color:orange;">(Correction non spécifiée/invalide)</div>`;
                        }
                        currentItemHtml += `</div>`;
                    }
                }
                li.innerHTML = currentItemHtml;
                sectionHtml += li.outerHTML;
            });
            sectionHtml += `</ul>`;
            return sectionHtml;
        }

        async function renderImageFromHtml(htmlToRender, imageElement, placeholderElement, downloadLinkElement, processingButton, originalButtonText, combined = false) {
            const renderDiv = document.createElement('div');
            renderDiv.className = 'questions-render-container';
            renderDiv.innerHTML = htmlToRender;

            renderDiv.style.position = 'absolute';
            renderDiv.style.left = '-9999px';
            document.body.appendChild(renderDiv);

            try {
                const canvas = await html2canvas(renderDiv, {
                    scale: 1.5,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    logging: false
                });
                const imageDataUrl = canvas.toDataURL('image/png');
                imageElement.src = imageDataUrl;
                imageElement.classList.remove('hidden');
                placeholderElement.classList.add('hidden');
                downloadLinkElement.href = imageDataUrl;
                downloadLinkElement.classList.remove('hidden');
            } catch (error) {
                console.error('Erreur html2canvas:', error);
                placeholderElement.textContent = 'Erreur technique lors de la création de l\'image.';
                placeholderElement.classList.remove('hidden');
            } finally {
                if (document.body.contains(renderDiv)) {
                    document.body.removeChild(renderDiv);
                }
                if(processingButton) {
                    processingButton.disabled = false;
                    processingButton.textContent = originalButtonText;
                    const btnId = processingButton.id;
                    if (btnId.includes("With")) { document.getElementById(btnId.replace("With", "Without"))?.removeAttribute('disabled'); }
                    else if (btnId.includes("Without")) { document.getElementById(btnId.replace("Without", "With"))?.removeAttribute('disabled'); }
                }
            }
        }

        async function parseAndDisplaySingleExerciseImage(textInputArea, exerciseType, imageElement, placeholderElement, downloadLinkElement, processingButton, showCorrection) {
            const rawText = textInputArea.value.trim();
            const originalButtonText = processingButton.textContent;

            if (!rawText) {
                let message = `Veuillez coller le texte pour "${exerciseType === 'short' ? 'Questions Courtes' : 'QCM'}" avant de convertir.`;
                if (exerciseType === 'mcq') message += " Si vous avez collé un tableau Markdown, cliquez d'abord sur 'Convertir Tableau en Format QCM'.";
                alert(message);
                textInputArea.focus();
                return;
            }
             if (typeof html2canvas === 'undefined') { alert("La librairie html2canvas n'est pas chargée. Veuillez vérifier votre connexion internet ou contacter l'administrateur."); return; }

            processingButton.disabled = true;
            processingButton.textContent = "Traitement...";
            const btnId = processingButton.id;
            if (btnId.includes("With")) { document.getElementById(btnId.replace("With", "Without"))?.setAttribute('disabled', 'true'); }
            else if (btnId.includes("Without")) { document.getElementById(btnId.replace("Without", "With"))?.setAttribute('disabled', 'true');}


            placeholderElement.textContent = 'Analyse et génération de l\'image...';
            imageElement.classList.add('hidden');
            downloadLinkElement.classList.add('hidden');
            placeholderElement.classList.remove('hidden');

            const parsedItems = parseExerciseText(rawText, exerciseType, showCorrection);
            let hasValidItems = parsedItems.some(item => !item.parsingError && !item.error);

            if (!hasValidItems && parsedItems.length > 0) {
                 let errorToShow = "Erreurs de format dans toutes les données. ";
                 if (parsedItems[0].parsingError) errorToShow += parsedItems[0].parsingError;
                 else if (parsedItems[0].error && parsedItems[0].data.answer) errorToShow += parsedItems[0].data.answer;
                 placeholderElement.textContent = errorToShow.substring(0,150);

            } else if (parsedItems.length === 0 && rawText.length > 0) {
                placeholderElement.textContent = "Aucune donnée valide extraite. Vérifiez le format.";
                if(exerciseType === 'mcq') placeholderElement.textContent += " Si vous avez collé un tableau, utilisez d'abord 'Convertir Tableau...'.";
            } else if (parsedItems.length === 0) {
                 placeholderElement.textContent = "Aucune donnée à traiter.";
            }

            if (!hasValidItems) {
                imageElement.classList.add('hidden');
                placeholderElement.classList.remove('hidden');
                downloadLinkElement.classList.add('hidden');
                processingButton.disabled = false;
                processingButton.textContent = originalButtonText;
                if (btnId.includes("With")) { document.getElementById(btnId.replace("With", "Without"))?.removeAttribute('disabled'); }
                else if (btnId.includes("Without")) { document.getElementById(btnId.replace("Without", "With"))?.removeAttribute('disabled');}
                return;
            }

            const title = exerciseType === 'short' ?
                (showCorrection ? 'Questions à Réponses Courtes' : 'Questions à Réponses Courtes (Exercice)') :
                (showCorrection ? 'Questions à Choix Multiples' : 'Questions à Choix Multiples (Exercice)');

            const validItemsToRender = parsedItems.filter(item => !item.parsingError && !item.error);
            const htmlToRender = buildExerciseHtml(validItemsToRender, showCorrection, exerciseType, title);

            await renderImageFromHtml(htmlToRender, imageElement, placeholderElement, downloadLinkElement, processingButton, originalButtonText);
        }

        async function generateCombinedImage(showCorrection) {
            const rawTextShort = textShortQuestionsInput.value.trim();
            const rawTextMCQ = textMCQInput.value.trim();
            const btnWithCorrection = convertCombinedToImageWithCorrectionBtn;
            const btnWithoutCorrection = convertCombinedToImageWithoutCorrectionBtn;
            const originalTextWith = btnWithCorrection.textContent;
            const originalTextWithout = btnWithoutCorrection.textContent;

            if (!rawTextShort && !rawTextMCQ) {
                alert("Veuillez fournir du texte pour au moins un type d'exercice (Questions Courtes ou QCM).");
                return;
            }
            if (typeof html2canvas === 'undefined') { alert("La librairie html2canvas n'est pas chargée."); return; }

            btnWithCorrection.disabled = true;
            btnWithCorrection.textContent = "Traitement...";
            btnWithoutCorrection.disabled = true;
            btnWithoutCorrection.textContent = "Traitement...";


            combinedPlaceholder.textContent = 'Analyse et génération de l\'image combinée...';
            combinedImage.classList.add('hidden');
            downloadCombinedLink.classList.add('hidden');
            combinedPlaceholder.classList.remove('hidden');

            let combinedHtml = "";
            let hasValidContent = false;
            let processingMessages = [];

            if (rawTextShort) {
                const parsedShort = parseExerciseText(rawTextShort, 'short', showCorrection);
                const validShortItems = parsedShort.filter(item => !item.error && !item.parsingError);
                if (validShortItems.length > 0) {
                    const shortTitle = showCorrection ? 'Questions à Réponses Courtes' : 'Questions à Réponses Courtes (Exercice)';
                    combinedHtml += buildExerciseHtml(validShortItems, showCorrection, 'short', shortTitle);
                    hasValidContent = true;
                }
                if (parsedShort.length > validShortItems.length) processingMessages.push(`${parsedShort.length - validShortItems.length} question(s) courte(s) ignorée(s) (erreur format).`);
            }

            if (rawTextMCQ) {
                if (hasValidContent && combinedHtml.endsWith("</ul>")) {
                     combinedHtml = combinedHtml.slice(0, -5);
                     combinedHtml += `<li class="question-item" style="border-bottom: 2px solid #63b3ed !important; margin-bottom:25px; padding-bottom:25px;"></li></ul>`; // Adjusted color
                }
                const parsedMCQ = parseExerciseText(rawTextMCQ, 'mcq', showCorrection);
                const validMCQItems = parsedMCQ.filter(item => !item.parsingError);

                if (validMCQItems.length > 0) {
                    const mcqTitle = showCorrection ? 'Questions à Choix Multiples' : 'Questions à Choix Multiples (Exercice)';
                    combinedHtml += buildExerciseHtml(validMCQItems, showCorrection, 'mcq', mcqTitle);
                    hasValidContent = true;
                }
                 if (parsedMCQ.length > validMCQItems.length) processingMessages.push(`${parsedMCQ.length - validMCQItems.length} QCM ignoré(s) (erreur format).`);

                 if (validMCQItems.length === 0 && parsedMCQ.length > 0 && parsedMCQ[0].parsingError && parsedMCQ[0].parsingError.includes("Convertir Tableau")) {
                     processingMessages.push("QCM: Erreur, si vous avez collé un tableau, veuillez le convertir d'abord.");
                 }
            }

            if (processingMessages.length > 0) {
                 combinedPlaceholder.textContent = "Traitement avec avertissements: " + processingMessages.join(' | ');
            }

            if (!hasValidContent) {
                if (processingMessages.length === 0) combinedPlaceholder.textContent = "Aucun contenu valide à afficher pour l'image combinée.";
                btnWithCorrection.disabled = false;
                btnWithCorrection.textContent = originalTextWith;
                btnWithoutCorrection.disabled = false;
                btnWithoutCorrection.textContent = originalTextWithout;
                return;
            }

            await renderImageFromHtml(combinedHtml, combinedImage, combinedPlaceholder, downloadCombinedLink, null, null, true);
            btnWithCorrection.disabled = false;
            btnWithCorrection.textContent = originalTextWith;
            btnWithoutCorrection.disabled = false;
            btnWithoutCorrection.textContent = originalTextWithout;
        }

        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        function generateDocxHtmlContent(parsedItems, exerciseType, showCorrection, docTitle) {
            let htmlContent = `<!DOCTYPE html><html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>${escapeHtml(docTitle)}</title>`;
            htmlContent += `<style>
                body{font-family: Calibri, Arial, sans-serif; font-size:11pt; margin: 1in;}
                h1{font-size:18pt; font-weight:bold; margin-bottom:24px; color:#2E74B5; text-align:center;}
                p{margin-bottom:6px; line-height:1.3;}
                ul{margin-top:0px; padding-left:30px;}
                li{margin-bottom:4px; line-height:1.3;}
                .question-block{margin-bottom: 18px; padding-bottom: 12px; border-bottom: 1px solid #BFBFBF;}
                .question-block:last-child{border-bottom: none;}
                .question-text{font-weight:bold; margin-bottom:6px; font-size:12pt;}
                .answer-text{font-style:italic; color:#38761D; margin-left:20px;}
                .mcq-option{margin-left:0px;}
                .correction-text{font-style:italic; font-weight:bold; color:#38761D; margin-left:0px;}
                .placeholder-line{color:#7F7F7F; font-style:italic;}
            </style></head><body>`;
            htmlContent += `<h1>${escapeHtml(docTitle)}</h1>`;

            let itemCounter = 0;
            parsedItems.forEach(item => {
                itemCounter++;
                htmlContent += `<div class='question-block'>`;
                htmlContent += `<p class='question-text'>${itemCounter}. ${escapeHtml(item.data.question || 'Question non définie')}</p>`;

                if (item.type === 'short') {
                    if (showCorrection) {
                        htmlContent += `<p class='answer-text'>Réponse attendue : ${escapeHtml(item.data.answer || 'Réponse non définie')}</p>`;
                    } else {
                        htmlContent += "<p class='placeholder-line'>Réponse : ________________________________________________</p>";
                    }
                } else if (item.type === 'mcq') {
                    if (item.data.options && item.data.options.length > 0) {
                        htmlContent += "<ul style='list-style-type: none; padding-left: 20px;'>"; // Using custom prefix in li
                        item.data.options.forEach((optText, index) => {
                            htmlContent += `<li class='mcq-option'>${String.fromCharCode(65 + index)}. ${escapeHtml(optText || 'Option non définie')}</li>`;
                        });
                        htmlContent += "</ul>";
                    }
                    if (showCorrection && item.data.correctAnswerLetter) {
                        htmlContent += `<p class='correction-text'>Bonne réponse : ${escapeHtml(item.data.correctAnswerLetter)}</p>`;
                    } else if (!showCorrection) {
                        htmlContent += "<p class='placeholder-line'>Votre choix : _____</p>";
                    }
                }
                htmlContent += `</div>`;
            });
            if (itemCounter === 0) {
                htmlContent += "<p>Aucun exercice valide à exporter.</p>";
            }
            htmlContent += "</body></html>";
            return htmlContent;
        }

        function triggerDocDownload(htmlContent, filename) {
            const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(htmlContent);
            const fileDownload = document.createElement("a");
            document.body.appendChild(fileDownload);
            fileDownload.href = source;
            fileDownload.download = filename;
            fileDownload.click();
            document.body.removeChild(fileDownload);
        }

        function handleExerciseDocxExport(textInputAreaId, exerciseType, showCorrection) {
            const textInputArea = document.getElementById(textInputAreaId);
            const rawText = textInputArea.value.trim();

            if (!rawText) {
                let message = `Veuillez coller le texte pour "${exerciseType === 'short' ? 'Questions Courtes' : 'QCM'}" avant d'exporter en DOCX.`;
                if (exerciseType === 'mcq') message += " Si vous avez collé un tableau Markdown, cliquez d'abord sur 'Convertir Tableau en Format QCM'.";
                alert(message);
                textInputArea.focus();
                return;
            }

            const parsedItems = parseExerciseText(rawText, exerciseType, showCorrection);
            const validItems = parsedItems.filter(item => !item.parsingError && !item.error);

            if (validItems.length === 0) {
                let errorMsg = "Aucun exercice valide trouvé à exporter. ";
                if (parsedItems.length > 0 && parsedItems[0].parsingError) {
                    errorMsg += `Détail de la première erreur : ${parsedItems[0].parsingError}`;
                } else if (parsedItems.length > 0 && parsedItems[0].error) {
                     errorMsg += `Détail de la première erreur : ${parsedItems[0].data.answer}`;
                }
                 else {
                    errorMsg += "Vérifiez le format des données.";
                }
                alert(errorMsg);
                return;
            }

            let docTitle = "";
            let filename = "";

            if (exerciseType === 'short') {
                docTitle = showCorrection ? 'Questions à Réponses Courtes (Corrigé)' : 'Questions à Réponses Courtes (Exercice)';
                filename = showCorrection ? 'questions_courtes_corrige.doc' : 'questions_courtes_exercice.doc';
            } else { // mcq
                docTitle = showCorrection ? 'Questions à Choix Multiples (Corrigé)' : 'Questions à Choix Multiples (Exercice)';
                filename = showCorrection ? 'qcm_corrige.doc' : 'qcm_exercice.doc';
            }

            const htmlContent = generateDocxHtmlContent(validItems, exerciseType, showCorrection, docTitle);
            triggerDocDownload(htmlContent, filename);
        }

        // Event Listeners pour Section 3
        convertShortToImageWithCorrectionBtn.addEventListener('click', () => {
            parseAndDisplaySingleExerciseImage(textShortQuestionsInput, 'short', shortQuestionsImage, shortQuestionsPlaceholder, downloadShortLink, convertShortToImageWithCorrectionBtn, true);
        });
        convertShortToImageWithoutCorrectionBtn.addEventListener('click', () => {
            parseAndDisplaySingleExerciseImage(textShortQuestionsInput, 'short', shortQuestionsImage, shortQuestionsPlaceholder, downloadShortLink, convertShortToImageWithoutCorrectionBtn, false);
        });
        exportShortToDocxWithCorrectionBtn.addEventListener('click', () => {
            handleExerciseDocxExport('textShortQuestionsInput', 'short', true);
        });
        exportShortToDocxWithoutCorrectionBtn.addEventListener('click', () => {
            handleExerciseDocxExport('textShortQuestionsInput', 'short', false);
        });

        convertMCQTableBtn.addEventListener('click', convertMarkdownTableToMCQTextFormat);
        convertMCQToImageWithCorrectionBtn.addEventListener('click', () => {
            parseAndDisplaySingleExerciseImage(textMCQInput, 'mcq', mcqImage, mcqPlaceholder, downloadMcqLink, convertMCQToImageWithCorrectionBtn, true);
        });
        convertMCQToImageWithoutCorrectionBtn.addEventListener('click', () => {
            parseAndDisplaySingleExerciseImage(textMCQInput, 'mcq', mcqImage, mcqPlaceholder, downloadMcqLink, convertMCQToImageWithoutCorrectionBtn, false);
        });
        exportMCQToDocxWithCorrectionBtn.addEventListener('click', () => {
            handleExerciseDocxExport('textMCQInput', 'mcq', true);
        });
        exportMCQToDocxWithoutCorrectionBtn.addEventListener('click', () => {
            handleExerciseDocxExport('textMCQInput', 'mcq', false);
        });

        // Event Listeners pour Section 4
        convertCombinedToImageWithCorrectionBtn.addEventListener('click', () => generateCombinedImage(true));
        convertCombinedToImageWithoutCorrectionBtn.addEventListener('click', () => generateCombinedImage(false));

        // --- LOGIQUE MODIFIÉE POUR SECTION 5 ---
        generateDesignModificationPromptBtn.addEventListener('click', function() {
            const existingHtmlCode = existingHtmlCourseCodeInput.value.trim();
            if (!existingHtmlCode) {
                alert("Veuillez d'abord coller le code HTML complet de votre cours existant dans la zone de texte dédiée.");
                existingHtmlCourseCodeInput.focus();
                designModificationPromptOutput.value = "";
                return;
            }

            // Simple check to see if it *might* be HTML
            if (!existingHtmlCode.toLowerCase().includes("<html") || !existingHtmlCode.toLowerCase().includes("<body")) {
                alert("Le texte collé ne semble pas être un code HTML valide. Veuillez vérifier et coller le code HTML complet de votre cours.");
                existingHtmlCourseCodeInput.focus();
                designModificationPromptOutput.value = "";
                return;
            }

            let designInstructionsSection = `\n\nMaintenant, applique les modifications de design suivantes à ce code HTML :\n\n**Directives de Design à Appliquer :**\n`;
            designInstructionsSection += `*   **Palette de couleurs :**\n`;
            designInstructionsSection += `    *   Couleur Primaire : ${designColorPrimary.value}. Utilise-la pour les éléments principaux (titres h1, liens importants, accents de boutons interactifs, etc.).\n`;
            designInstructionsSection += `    *   Couleur Secondaire : ${designColorSecondary.value}. Utilise-la pour les éléments secondaires (sous-titres h2/h3, fonds d'encarts d'information, etc.).\n`;
            designInstructionsSection += `    *   Couleur d'Accentuation : ${designColorAccent.value}. Utilise-la pour des éléments spécifiques à mettre en valeur (ex: "Le saviez-vous ?", citations, etc.).\n`;
            designInstructionsSection += `*   **Style Général / Ambiance souhaitée :** Applique un style "${designGeneralStyle.value}". Décris à l'IA comment interpréter ce style (ex: pour "Moderne et épuré", mentionner: espacements généreux, typographie sans-serif lisible, lignes épurées, éviter surcharges graphiques).\n`;
            designInstructionsSection += `*   **Style des Pictogrammes :** "${designIconStyle.value}". Si des icônes sont suggérées, précise où et quel type d'icône (ex: "icône de robot à côté du titre principal H1").\n`;

            const images = designImageInstructions.value.trim();
            if (images) {
                designInstructionsSection += `*   **Insertion d'Images :**\n`;
                images.split('\n').forEach(line => {
                    if (line.trim()) {
                        const parts = line.split('---');
                        const url = parts[0] ? parts[0].trim() : '';
                        const locationDesc = parts[1] ? parts[1].trim() : 'emplacement non spécifié, à déterminer logiquement';
                        if (url) {
                             designInstructionsSection += `    *   Insère l'image depuis l'URL ${url} (vérifie la conformité des droits). Emplacement suggéré : ${locationDesc}. L'image doit être responsive, idéalement centrée, et avoir un attribut 'alt' descriptif.\n`;
                        }
                    }
                });
            }

            const otherImprovements = designOtherImprovements.value.trim();
            if (otherImprovements) {
                designInstructionsSection += `*   **Autres Améliorations de Design Spécifiques (instructions pour l'IA) :**\n ${otherImprovements.replace(/^/gm, '    *   ')}\n`;
            }

            designInstructionsSection += `\nConserve tout le contenu textuel et la structure sémantique du cours original. Les modifications doivent porter principalement sur l'aspect visuel (CSS, potentiellement quelques balises HTML pour structurer les ajouts comme les images) et l'intégration des éléments demandés.\n`;
            designInstructionsSection += `Assure-toi que tout le CSS ajouté ou modifié est bien intégré dans une unique balise <style> dans le <head> du document HTML fourni, ou que les styles en ligne sont utilisés judicieusement. Ne pas créer de fichiers CSS externes.\n`;
            designInstructionsSection += `Le pied de page de la page web, s'il existe ou est à créer/modifier, doit contenir le texte "Technologie Collège".\n`;
            designInstructionsSection += `Fournis uniquement le code HTML complet et modifié en sortie. Ne rajoute pas de texte avant ou après le code HTML final.\n`;


            const finalPrompt = `Tu es un expert en développement web frontend (HTML, CSS, JavaScript) et en design d'interface utilisateur.
Ta tâche est de modifier le code HTML de la page de cours suivante pour y intégrer les améliorations de design spécifiées.

Voici le code HTML actuel de la page de cours à modifier :
--- DÉBUT DU CODE HTML ACTUEL ---
${existingHtmlCode}
--- FIN DU CODE HTML ACTUEL ---
${designInstructionsSection}`;

            designModificationPromptOutput.value = finalPrompt;
            designModificationPromptOutput.scrollTop = 0;
            copyDesignModificationPromptMessage.textContent = "Prompt de modification généré !";
             setTimeout(() => { copyDesignModificationPromptMessage.textContent = ''; }, 4000);
        });

        copyDesignModificationPromptBtn.addEventListener('click', () => {
            copyToClipboardUtil(designModificationPromptOutput.value, copyDesignModificationPromptMessage, "Prompt de Modification copié !");
        });

    </script>
</body>
</html>